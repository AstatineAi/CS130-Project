{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u64cd\u4f5c\u7cfb\u7edf \u8bfe\u7a0b\u7b14\u8bb0","text":"<p>No plagiarism</p> <p>If you are enrolled in CS130, you may not copy code from this repository.</p> <p>Abstract</p> <p>\u8ba1\u7b97\u673a\u7cfb\u7edf\u76f8\u5173\u5b66\u4e60\u7b14\u8bb0</p> <ul> <li>\u4e0a\u6d77\u79d1\u6280\u5927\u5b66 2024 \u6625\u5b66\u671f CS130 \u64cd\u4f5c\u7cfb\u7edf I \u8bfe\u7a0b\u7b14\u8bb0</li> <li>\u5176\u4ed6\u8ba1\u7b97\u673a\u7cfb\u7edf\u77e5\u8bc6</li> <li>Lab: Pintos \u76f8\u5173\u5185\u5bb9</li> </ul> <p>Credit: Astinita</p>"},{"location":"lec0/","title":"Lecture 0 : environment configurations","text":"<p>deprecated: \u4ec5\u4ec5\u8bb0\u5f55\u5f00\u8bfe\u524d\u5728\u81ea\u5df1\u7535\u8111\u4e0a\u5b89\u88c5\u9047\u5230\u7684\u95ee\u9898\u548c trouble shooting, \u5177\u4f53\u914d\u7f6e\u8bf7\u53c2\u8003\u4e60\u9898\u8bfe.</p> <p>\u6211\u7684\u73af\u5883</p> <p>\u8bf7\u5c3d\u91cf\u9009\u62e9\u65e7\u7248\u672c\u7684 Debian \u53ca\u5176\u884d\u751f\u53d1\u884c\u7248, \u5982 Ubuntu 18.04 LTS. (\u53c2\u89c1\u4e0b\u65b9\u5b89\u88c5\u65f6 <code>stropts.h</code> \u90e8\u5206)</p> <pre><code>Linux version 5.15.133.1-microsoft-standard-WSL2\n\nUbuntu 22.04 (extremely bad choice, not recommanded)\n\nGCC 11.2.0\n</code></pre> <p>64 \u4f4d\u7cfb\u7edf.</p> <p>WSL \u63d0\u793a\u65e0\u6cd5\u5b89\u88c5\u8bf7\u53c2\u8003 https://learn.microsoft.com/zh-cn/windows/wsl/troubleshooting#installation-issues.</p>"},{"location":"lec0/#_1","title":"\u5176\u4ed6\u53ef\u80fd (\u663e\u7136) \u66f4\u4f18\u7684\u6559\u7a0b","text":"<ol> <li>\u4f7f\u7528 UC Berkeley \u7684\u4ed3\u5e93 : https://github.com/Berkeley-CS162</li> <li>\u4f7f\u7528 JHU \u7684\u4ed3\u5e93 : https://www.cs.jhu.edu/~huang/cs318/fall17/project/guide.html</li> <li>\u4f7f\u7528 PKU \u7684 docker : https://pkuflyingpig.gitbook.io/pintos/</li> <li>https://github.com/youcunhan/cs130-OperatingSystem-pintos/blob/master/pintos-install.sh</li> </ol>"},{"location":"lec0/#_2","title":"\u73af\u5883\u8981\u6c42","text":"<p>https://web.stanford.edu/class/cs140/projects/pintos/pintos_12.html</p>"},{"location":"lec0/#_3","title":"\u524d\u7f6e\u5b89\u88c5/\u4e0b\u8f7d","text":"<p>\u9996\u5148: <code>sudo apt-get update</code> \u5e76\u4e14 <code>sudo apt-get upgrade</code></p> <p><code>sudo apt-get -y install build-essential automake git libncurses5-dev texinfo expat libexpat1-dev wget</code></p> <p>\u83b7\u53d6 pintos: <code>git clone git://pintos-os.org/pintos-anon pintos</code></p> <p>\u7531\u4e8e\u8fd9\u91cc\u662f git protocol, \u8bbe\u7f6e git \u7684 <code>http.proxy</code> \u662f\u4e00\u70b9\u7528\u6ca1\u6709\u7684, \u4e0b\u8f7d\u901f\u5ea6\u6162\u662f\u6b63\u5e38\u73b0\u8c61.</p>"},{"location":"lec0/#_4","title":"\u6a21\u62df\u5668","text":""},{"location":"lec0/#qemu","title":"QEMU","text":"<p><code>sudo apt-get -y install qemu-system</code></p>"},{"location":"lec0/#bochs-267","title":"Bochs 2.6.7","text":"<p>\u4e0b\u8f7d bochs: https://sourceforge.net/projects/bochs/files/bochs/2.6.7/</p> <p>\u5207\u6362\u5230 <code>.tar.gz</code> \u6587\u4ef6\u7684\u76ee\u5f55:</p> <pre><code>tar zxvf bochs-2.6.7.tar.gz\n\ncd bochs-2.6.7\n\n./configure --enable-gdb-stub\n\nmake\n\nsudo make install\n</code></pre> <p>\u7136\u540e\u56de\u5230 pintos \u7684\u76ee\u5f55, \u8fd0\u884c\u547d\u4ee4 <code>bochs --help</code> \u4f1a\u63d0\u793a\u4f60\u7248\u672c\u662f <code>2.6.7</code> \u4e14\u662f\u521a\u521a\u7f16\u8bd1\u7684.</p>"},{"location":"lec0/#pintos-qemu","title":"\u914d\u7f6e Pintos (\u4f7f\u7528 qemu)","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u8fd0\u884c pintos, \u5728 <code>.bashrc</code> \u52a0\u4e0a\u5bf9\u5e94\u4f4d\u7f6e\u7684 export \u547d\u4ee4.</p> <ul> <li>\u5207\u6362\u5230 <code>pintos/src/utils</code> \u76ee\u5f55, \u6253\u5f00 <code>pintos-gdb</code>, \u4fee\u6539 <code>GDBMACROS</code> \u5230 <code>pintos/src/misc/gdb-macros</code>.</li> <li>\u6253\u5f00 <code>Makefile</code>, \u628a\u53d8\u91cf\u540d <code>LOADLIBES</code> \u6539\u4e3a <code>LDLIBS</code></li> <li>\u7531\u4e8e\u9ad8\u7248\u672c Linux \u6ca1\u6709 <code>stropts.h</code> \u5e93, \u5728 <code>/usr/include/</code> \u4e0b\u9762\u65b0\u5efa\u4e00\u4e2a\u7a7a\u7684\u5373\u53ef</li> <li>\u6ce8\u91ca\u6389 <code>squish-pty.c</code> 288 - 294 \u884c</li> </ul> <p>\u6b64\u65f6\u5728 <code>pintos/src/utils</code> \u4e0b <code>make</code>, \u53ea\u6709 warning.</p> <ul> <li><code>/src/threads/Make.vars</code> 7 \u884c <code>bochs</code> \u6539\u4e3a <code>qemu</code></li> <li><code>/utils/pintos</code> 103 \u884c\u5de6\u53f3 <code>bochs</code> \u6539\u4e3a <code>qemu</code></li> <li><code>/utils/pintos</code> 621 \u884c\u5de6\u53f3: <code>qemu</code> \u6539\u4e3a <code>qemu-system-x86_64</code></li> </ul> <p>\u5728 <code>pintos/src/threads</code> \u4e0b:</p> <pre><code>make\n\ncd build\n\npintos --qemu -- run alarm-multiple\n</code></pre> <p>\u80fd\u8dd1\u5c31\u662f\u57fa\u672c\u6210\u529f.</p> <p>\u5728 <code>pintos/src/threads/build/</code> \u4e0b:</p> <pre><code>make check\n</code></pre> <p>\u8fdb\u5165\u6f2b\u957f\u7684\u7b49\u5f85\u65f6\u95f4.</p> <p>27 fail 20 \u5c31\u662f\u5b8c\u5168\u6210\u529f.</p> <p>\u5728\u6211\u7528 WSL \u547d\u4ee4\u884c\u548c vim \u6539\u4e86\u8bb8\u4e45\u4e4b\u540e, \u7a81\u7136\u60f3\u8d77\u6765\u5176\u5b9e\u76f4\u63a5\u5728\u6253\u5f00\u4e86\u5bf9\u5e94\u6587\u4ef6\u5939\u7684 VS Code \u5c31\u80fd\u5feb\u901f\u5b8c\u6210\u8fd9\u4e9b\u7834\u4e8b\u4e86.</p>"},{"location":"lec0/#gdb-debug","title":"\u4f7f\u7528 gdb \u8fdb\u884c debug","text":"<p>\u5f00\u542f\u4e24\u4e2a\u7ec8\u7aef, \u7b2c\u4e00\u4e2a\u5728 <code>pintos/src/threads/build/</code> \u4e0b <code>pintos --qemu --gdb -- run testName</code></p> <p>\u5728 <code>pintos/src/threads/build/</code> \u4e0b <code>pintos-gdb</code></p> <p>\u5c1d\u8bd5\u8fd0\u884c <code>debugpintos</code> (\u5728 gdb macros \u91cc\u9762\u58f0\u660e\u7684, \u7528\u5904\u662f\u8fde\u63a5\u5230 qemu, \u76f4\u63a5\u7528 <code>target remote localhost:1234</code> \u4e5f\u53ef\u4ee5)</p> <p>\u65e0\u62a5\u9519\u6216\u8005\u8fd0\u884c\u540e\u518d\u8fd0\u884c\u6307\u4ee4 <code>c</code> \u53ef\u4ee5\u6b63\u5e38\u7ee7\u7eed\u5c31\u662f\u914d\u7f6e\u6b63\u786e.</p> <p>\u5982\u679c\u51fa\u73b0 <code>architecture</code> \u76f8\u5173\u62a5\u9519, \u8fdb\u5165\u540e\u8fd0\u884c <code>set architecture i386:x86-64</code>, \u7136\u540e\u8fd0\u884c <code>debugpintos</code></p> <p>\u4e4b\u540e\u53ef\u4ee5\u6b63\u5e38\u6253\u65ad\u70b9\u8fd0\u884c.</p>"},{"location":"lec3/","title":"Lec 3: Process","text":""},{"location":"lec3/#_1","title":"Lec 3: Process","text":""},{"location":"pintos/proj1/","title":"Project 1: Threads","text":"<p>No plagiarism</p> <p>If you are enrolled in CS130, you may not copy code from this repository.</p> <p>Overview</p> <ul> <li>Task 1 : solve busy waiting</li> <li>Task 2 :<ul> <li>priority scheduling (Round Robin)</li> <li>priority donation</li> </ul> </li> <li>Task3 : advanced scheduler</li> </ul>"},{"location":"pintos/proj1/#task-1","title":"Task 1","text":"<p><code>src/device/timer.c</code> \u89e3\u51b3 <code>timer_sleep()</code> \u7684 busy waiting \u95ee\u9898.</p> <pre><code>/* Sleeps for approximately TICKS timer ticks.  Interrupts must\n   be turned on. */\nvoid\ntimer_sleep (int64_t ticks) \n{\n  int64_t start = timer_ticks ();\n\n  ASSERT (intr_get_level () == INTR_ON);\n  while (timer_elapsed (start) &lt; ticks) \n    thread_yield ();\n}\n</code></pre> <p>\u6846\u67b6\u4ee3\u7801\u5b9e\u73b0: \u4e0d\u65ad\u5faa\u73af\u68c0\u67e5\u662f\u5426\u7b49\u5f85\u4e86\u8db3\u591f\u7684 ticks, \u82e5\u7b49\u5f85\u6ca1\u6709\u7ed3\u675f\u5219\u6302\u8d77\u7ebf\u7a0b.</p> <p><code>int64_t start = timer_ticks ();</code></p> <p><code>timer_ticks()</code> \u9996\u5148\u7981\u6b62 interrupt, \u7136\u540e\u83b7\u53d6\u8fd0\u884c\u603b ticks, \u6700\u540e\u6062\u590d interrupt \u72b6\u6001, \u4fdd\u8bc1\u539f\u5b50\u6027.</p> <p>\u7136\u540e\u5728\u7b49\u5f85\u8db3\u591f ticks \u4e4b\u524d\u4e00\u76f4 <code>thread_yield ()</code></p> <pre><code>/* Yields the CPU.  The current thread is not put to sleep and\n   may be scheduled again immediately at the scheduler's whim. */\nvoid\nthread_yield (void) \n{\n  struct thread *cur = thread_current ();\n  enum intr_level old_level;\n\n  ASSERT (!intr_context ());\n\n  old_level = intr_disable ();\n  if (cur != idle_thread) \n    list_push_back (&amp;ready_list, &amp;cur-&gt;elem);\n  cur-&gt;status = THREAD_READY;\n  schedule ();\n  intr_set_level (old_level);\n}\n</code></pre> <p>\u5f53\u524d thread \u867d\u7136\u8ba9\u51fa CPU \u4f46\u662f\u53c8\u5728 <code>ready_list</code> \u91cc\u9762\u52a0\u4e0a\u81ea\u5df1, \u5bfc\u81f4 busy_waiting, \u9700\u8981\u4e00\u4e2a\u7edf\u4e00\u7684\u5524\u9192\u65b9\u5f0f, \u907f\u514d\u91cd\u590d <code>thread_yield()</code>.</p> <p>\u8003\u8651\u7ef4\u62a4\u4e00\u4e2a\u6309\u7167\u5524\u9192\u65f6\u95f4\u4e3a\u5173\u952e\u5b57\u7684\u4f18\u5148\u961f\u5217, \u4f7f\u7528\u4e8c\u53c9\u5806\u5b9e\u73b0.</p> <p>\u6700\u5f00\u59cb\u4f7f\u7528\u4e86</p> <pre><code>struct sleep_thream_elem\n{\n  struct thread *t;\n  int64_t wake_time;\n};\n</code></pre> <p>\u4f5c\u4e3a\u5806\u5185\u5b58\u50a8\u5bf9\u8c61, \u4f46\u662f\u8fd9\u6837\u5c31\u9700\u8981 <code>malloc()</code> \u548c <code>free()</code>, \u5728 <code>timer_interrupt()</code> \u8fc7\u7a0b\u4e2d\u65e0\u6cd5\u5b9e\u73b0, \u4e8e\u662f\u76f4\u63a5\u5728 <code>struct thread</code> \u5185\u52a0\u4e0a <code>wake_time</code>, \u5728 <code>timer_sleep()</code> \u65f6\u5c06\u7ebf\u7a0b\u963b\u585e, \u7136\u540e push \u5230\u5806\u5185.</p> <p>\u5728 <code>timer_interrupt()</code> \u7684\u65f6\u5019\u68c0\u67e5\u5806\u9876\u5143\u7d20\u662f\u5426\u5c31\u7eea, \u5c31\u7eea\u5219 <code>thread_unblock()</code>.</p> <p>\u6b64\u65f6\u89e3\u51b3\u4e86:</p> <pre><code>alarm-wait\nalarm-simultaneous\nalarm-zero\nalarm-negative\n</code></pre>"},{"location":"pintos/proj1/#task-2","title":"Task 2","text":""},{"location":"pintos/proj1/#alarm-priority","title":"alarm-priority","text":"<p>\u8981\u6c42\u9ad8\u4f18\u5148\u7ea7\u7684\u51c6\u5907\u7ebf\u7a0b\u4f18\u5148\u8fd0\u884c, \u4f7f\u7528\u5806, \u6bd4\u8f83 <code>priority</code> \u5373\u53ef.</p>"},{"location":"pintos/proj1/#priority-change","title":"priority-change","text":"<p>\u8981\u6c42\u5728\u66f4\u65b0\u4e00\u4e2a\u7ebf\u7a0b\u4f18\u5148\u7ea7\u4e4b\u540e, \u82e5\u5176\u4e0d\u662f\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u7ebf\u7a0b\u5219 yield.</p> <p>\u5728 <code>thread_set_priority()</code> \u65f6\u76f4\u63a5 <code>thread_yield()</code>, \u82e5\u4ecd\u662f\u6700\u9ad8\u4f18\u5148\u7ea7\u5219\u6ca1\u6709\u5f71\u54cd.</p>"},{"location":"pintos/proj1/#priority-donate-one","title":"priority-donate-one","text":"<p>\u8fd9\u662f\u4e00\u4e2a\u6765\u81ea\u4e92\u65a5\u7684\u95ee\u9898. \u73b0\u5728\u6211\u4eec\u6709\u4e00\u628a\u9501, \u7136\u540e\u4e09\u4e2a\u7ebf\u7a0b <code>A, B, C</code> \u60f3\u8981\u83b7\u5f97\u9501, \u8fdb\u5165\u4e34\u754c\u533a, \u5176\u4f18\u5148\u7ea7\u987a\u5e8f\u662f <code>A &gt; B &gt; C</code>, \u6b64\u65f6 <code>C</code> \u5728\u4e34\u754c\u533a, <code>A</code> \u9700\u8981\u83b7\u5f97\u9501, \u4f46\u662f <code>B</code> \u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e <code>C</code>, \u4e0d\u65ad\u62a2\u5360 <code>C</code>, \u5bfc\u81f4 <code>A</code> \u867d\u7136\u5177\u6709\u6700\u9ad8\u4f18\u5148\u7ea7\u4f46\u662f\u4e00\u76f4\u65e0\u6cd5\u8fd0\u884c, \u8fd9\u5c31\u662f\u4f18\u5148\u7ea7\u53cd\u8f6c/\u4f18\u5148\u7ea7\u5012\u7f6e.</p> <p>\u9700\u8981\u5b9e\u73b0\u4f18\u5148\u7ea7\u6350\u8d60, \u5373\u5bf9\u4e8e\u9501, \u76ee\u524d\u6709 <code>A, C</code> \u9700\u8981\u5b83, \u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u9ad8\u4f18\u5148\u7ea7\u7684 <code>A</code> \u7684\u4f18\u5148\u7ea7\u53bb\u4ee3\u8868\u8fd9\u4e2a\u9501\u7684\u67d0\u79cd \"\u4f18\u5148\u7ea7\".</p> <p>\u4e5f\u5c31\u662f\u5728 <code>lock_acquire()</code> \u4f46\u662f\u5e76\u6ca1\u6709\u83b7\u53d6\u5230\u7684\u65f6\u5019\u9700\u8981\u8003\u8651\u5c06\u81ea\u5df1\u7684\u4f18\u5148\u7ea7\u8f6c\u4ea4\u7ed9 <code>lock</code>, \u8ba9\u5360\u7528 <code>lock</code> \u7684\u83b7\u53d6\u5230\u8fd9\u4e2a\u9ad8\u4f18\u5148\u7ea7\u5373\u53ef.</p>"},{"location":"pintos/proj1/#priority-donate-multiple","title":"priority-donate-multiple","text":"<p>\u88ab\u6350\u8d60\u4e86\u4f18\u5148\u7ea7\u4e0d\u4ee3\u8868\u7ebf\u7a0b\u53ef\u4ee5\u4e00\u76f4\u62ff\u7740\u90a3\u4e2a\u4f18\u5148\u7ea7, \u4e0d\u9700\u8981\u907f\u514d\u4f18\u5148\u7ea7\u53cd\u8f6c\u7684\u65f6\u5019, \u8981\u6062\u590d\u5230\u6ca1\u6350\u8d60\u7684\u4f18\u5148\u7ea7.</p>"},{"location":"pintos/proj1/#priority-donate-nest","title":"priority-donate-nest","text":"<p><code>A</code> \u7b49\u5f85 <code>B</code>, <code>B</code> \u7b49\u5f85 <code>C</code>, \u5219\u6350\u8d60\u53ef\u4ee5\u5d4c\u5957, \u5373 <code>A -&gt; B -&gt; C</code>, \u8ba9 <code>C</code> \u53ef\u4ee5\u5f97\u5230 <code>A</code> \u7684\u9ad8\u4f18\u5148\u7ea7.</p>"},{"location":"pintos/proj1/#priority-donate-sema","title":"priority-donate-sema","text":""},{"location":"pintos/proj1/#priority-donate-lower","title":"priority-donate-lower","text":"<p>\u5728\u88ab\u6350\u8d60\u7684\u65f6\u5019\u4fee\u6539\u7ebf\u7a0b\u4f18\u5148\u7ea7, \u82e5\u4f18\u5148\u7ea7\u4f4e\u4e8e\u6350\u8d60\u7684\u4f18\u5148\u7ea7, \u8fd9\u4e2a\u4fee\u6539\u5728\u6350\u8d60\u7ed3\u675f\u540e\u53ef\u4ee5\u751f\u6548.</p>"},{"location":"pintos/proj1/#priority-fifo","title":"priority-fifo","text":"<p>\u76f8\u540c\u4f18\u5148\u7ea7, \u5219\u5148\u8fdb\u5148\u51fa.</p> <p>\u9700\u8981\u989d\u5916\u8bb0\u5f55\u8fdb\u5165\u987a\u5e8f.</p>"},{"location":"pintos/proj1/#priority-preempt","title":"priority-preempt","text":"<p>\u9ad8\u4f18\u5148\u7ea7\u7ebf\u7a0b\u5c31\u7eea (<code>thread_create()</code> / <code>thread_unblock()</code>) \u65f6, \u62a2\u5360.</p>"},{"location":"pintos/proj1/#priority-sema","title":"priority-sema","text":"<p>\u5728\u4fe1\u53f7\u91cf\u5c31\u7eea\u7684\u65f6\u5019\u4f18\u5148\u5524\u9192\u7b49\u5f85\u6b64\u4fe1\u53f7\u91cf\u7684\u7ebf\u7a0b\u4e2d\u4f18\u5148\u7ea7\u9ad8\u7684.</p>"},{"location":"pintos/proj1/#priority-condvar","title":"priority-condvar","text":"<p>condition \u4e5f\u4f18\u5148\u5524\u9192\u4f18\u5148\u7ea7\u9ad8\u7684.</p>"},{"location":"pintos/proj1/#task-2_1","title":"Task 2 \u5b9e\u73b0","text":"<p>\u5206\u6790 <code>lock_acquire()</code> \u7684\u884c\u4e3a.</p> <pre><code>void\nlock_acquire (struct lock *lock)\n{\n  ASSERT (lock != NULL);\n  ASSERT (!intr_context ());\n  ASSERT (!lock_held_by_current_thread (lock));\n\n  sema_down (&amp;lock-&gt;semaphore);     /* \u5f97\u4e0d\u5230\u5c31\u7b49\u7740 */\n  lock-&gt;holder = thread_current (); /* \u7b49\u5230\u4e86\u5c31\u62ff\u8d70 */\n}\n</code></pre> <p>\u5982\u679c acquire \u6210\u529f\u4e86, \u5c1d\u8bd5\u66f4\u65b0\u81ea\u5df1\u7684 <code>priority</code> (\u88ab\u6350\u8d60).</p> <p>\u5982\u679c acquire \u5931\u8d25\u4e86, \u6350\u8d60\u81ea\u5df1\u7684 <code>priority</code>.</p> <p>\u574f\u4e86, \u90a3\u6211\u7f3a\u7684 lock \u6350\u8d60\u7ed9 thread \u8fd9\u5757\u8c01\u7ed9\u6211\u8865\u554a?</p> <p>\u601d\u8003\u5931\u8d25, \u91cd\u65b0\u601d\u8003.</p>"},{"location":"pintos/proj1/#_1","title":"\u7ebf\u7a0b\u7684\u884c\u4e3a","text":"<p>\u7ebf\u7a0b\u53ef\u4ee5\u5c1d\u8bd5\u83b7\u53d6\u591a\u628a\u9501, \u4f46\u662f\u5728\u7b2c\u4e00\u6b21 <code>lock_acquire()</code> \u5931\u8d25\u7684\u65f6\u5019\u5c31\u4f1a\u7b49\u5f85\u7b2c\u4e00\u628a\u9501, \u6682\u65f6\u4e0d\u4f1a\u628a\u4f18\u5148\u7ea7\u6350\u8d60\u7ed9\u4e0b\u4e00\u628a\u9501.</p> <p>\u4e3a\u4ec0\u4e48\u7b49\u5f85\u4e00\u628a\u9501\u4e0d\u662f busy waiting? \u56e0\u4e3a\u7ebf\u7a0b\u672c\u8eab\u88ab block, \u9700\u8981\u7b49\u5f85 lock-&gt;sema \u6765 unblock \u7ebf\u7a0b, \u6b64\u65f6\u4e5f\u8981\u4f18\u5148 unblock \u9ad8\u4f18\u5148\u7ea7\u7ebf\u7a0b. (\u6240\u4ee5\u5176\u5b9e\u53ef\u4ee5\u4f7f\u7528 <code>semaphore</code> \u6765\u5b8c\u6210 alarm \u90e8\u5206)</p> <p>\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u6301\u6709\u591a\u628a\u9501, \u5f97\u5230\u5176\u4e2d\u6700\u9ad8\u7684\u4f18\u5148\u7ea7\u7684\u6350\u8d60.</p> <p>\u62ff\u7740\u9501 = \u53ef\u80fd\u88ab donate</p> <p>\u7b49\u5f85\u9501 = donate \u7ed9\u522b\u7684 thread</p> <p>thread -&gt; lock: - donate \u53d1\u751f\u7684\u65f6\u95f4: acquire \u5931\u8d25, \u88ab block \u4e4b\u524d donate \u7ed9\u9501 - donate \u7ed3\u675f\u7684\u65f6\u95f4: \u7531 semaphore unblock, \u83b7\u5f97\u9501</p> <p>lock -&gt; thread: - donate \u53d1\u751f\u7684\u65f6\u95f4: acquire \u5931\u8d25, \u63a5\u53d7\u522b\u7684 donate \u4e4b\u540e donate \u7ed9 holder - donate \u7ed3\u675f\u7684\u65f6\u95f4: release, \u539f holder \u53ef\u4ee5\u63a5\u53d7\u5176\u4ed6\u9501\u7684 donation</p>"},{"location":"pintos/proj1/#priority","title":"\u5982\u4f55\u66f4\u65b0 <code>priority</code>?","text":"<p>\u65e0\u6b7b\u9501\u7684 donation \u7684\u5173\u7cfb\u6784\u6210\u4e00\u4e2a\u5185\u5411\u6811: \u6240\u6709\u7684\u7ebf\u7a0b\u6700\u591a\u7b49\u5f85\u4e00\u4e2a\u9501, \u5bf9\u90a3\u4e2a\u9501 donate, \u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u540c\u65f6\u6301\u6709\u591a\u4e2a\u9501, \u4ece\u591a\u4e2a\u9501\u83b7\u5f97 donation.</p> <p><code>lock_release()</code> \u53ea\u53d1\u751f\u5728\u6839\u8282\u70b9, \u6b64\u65f6\u4f1a\u5f97\u5230\u4e00\u4e2a\u65b0\u7684\u6839\u8282\u70b9, \u90a3\u4e2a\u8282\u70b9\u4e0d\u9700\u8981\u66f4\u65b0, \u66f4\u65b0\u8001\u7684\u6839\u8282\u70b9.</p> <p><code>lock_acquire()</code> \u662f\u52a0\u8fb9, \u9700\u8981\u5411\u7236\u4eb2\u8d21\u732e, \u76f4\u5230\u8fbe\u5230\u6839\u8282\u70b9.</p> <p><code>thread_set_priority()</code> \u53ea\u53d1\u751f\u5728\u6839\u8282\u70b9, \u65e0\u5f71\u54cd.</p> <p>\u4e24\u4e2a\u66f4\u65b0\u7684\u65b9\u5411:</p> <ol> <li>thread-&gt;lock_waiting (--\u6350\u8d60\u7ed9-&gt;) lock-&gt;holder (--\u6350\u8d60\u7ed9-&gt;) thread-&gt;lock_waiting (--\u6350\u8d60\u7ed9-&gt;) ...</li> <li>thread-&gt;locks_holding_list (--\u83b7\u53d6\u6350\u8d60-&gt;) lock-&gt;semaphor-&gt;waiters (--\u83b7\u53d6\u6350\u8d60-&gt;) thread-&gt;locks_holding_list (--\u83b7\u53d6\u6350\u8d60-&gt;)...</li> </ol> <p>\u4e00\u4e2a\u91cd\u8981\u7684\u884c\u4e3a\u662f: \u6350\u8d60\u4f18\u5148\u7ea7 (\u5373\u7b49\u5f85\u9501) \u7684 thread, \u5728\u5f97\u5230\u9501\u4e4b\u524d, \u8fd9\u4e2a thread \u7684 priority \u53ef\u80fd\u6539\u53d8.</p> <ul> <li>\u4e0d\u4f1a <code>thread_set_priority</code></li> <li>\u53ef\u80fd\u4ece\u522b\u5904\u5f97\u5230\u65b0\u7684 donation, \u5982 TA \u62ff\u7740\u9501 A \u7b49\u5f85\u9501 B, TB \u62ff\u7740\u9501 B, \u6b64\u65f6 TC \u8bf7\u6c42\u9501 A, TB \u7684\u4f18\u5148\u7ea7\u56e0\u6b64\u53d7\u5230 TC \u6350\u8d60.</li> </ul>"},{"location":"pintos/proj1/#thread_set_priority","title":"<code>thread_set_priority()</code>","text":"<p>\u66f4\u65b0\u975e\u6350\u8d60\u6240\u5f97\u7684\u4f18\u5148\u7ea7 <code>priority_original</code></p> <pre><code>- \u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u5728\u7b49\u9501 (\u4e00\u628a)\n  - \u6350\u8d60\u7ed9\u9501.\n  - \u9501\u9700\u8981\u8003\u8651\u4e4b\u524d\u6350\u8d60\u51fa\u7684\u4f18\u5148\u7ea7\u662f\u4e0d\u662f\u4e0d\u5b58\u5728\u4e86 (\u4f8b\u5982\u4f18\u5148\u7ea7 50 \u6350\u8d60\u51fa\u53bb, \u4f46\u662f 50 \u4f18\u5148\u7ea7\u7684\u7ebf\u7a0b\u88ab set \u5230\u4e86\u4f4e\u4f18\u5148\u7ea7).\n  - \u5982\u679c\u9ad8\u4e86\u6216\u8005\u6ca1\u73b0\u5728\u7684\u4f18\u5148\u7ea7\u4e0d\u662f\u6350\u8d60\u5f97\u5230\u7684, \u66f4\u65b0 `priority`\n</code></pre> <p>\u4e0a\u9762\u7684\u5206\u6790\u54ea\u91cc\u9519\u4e86?</p> <p>\u7b54\u6848\u5728\u4e8e, \u5728\u7b49\u5f85\u9501\u7684\u7ebf\u7a0b\u4f1a\u5904\u4e8e block \u72b6\u6001, \u4e0d\u80fd\u6539\u53d8\u4f18\u5148\u7ea7.</p> <p>\u6240\u4ee5\u8bf4, \u53ea\u6709\u6301\u6709\u9501\u7684\u7ebf\u7a0b\u6216\u8005\u548c\u9501\u65e0\u5173\u7684\u7ebf\u7a0b\u4f1a\u8fdb\u5165 <code>thread_set_priority()</code></p> <ul> <li> <p>\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u6301\u6709\u9501 (\u53ef\u80fd\u591a\u628a)</p> <ul> <li>\u9ad8\u4e8e\u6350\u8d60\u5f97\u5230\u7684\u4f18\u5148\u7ea7: \u66f4\u65b0 <code>priority</code></li> <li>\u4e0d\u9ad8\u4e8e\u6350\u8d60\u5f97\u5230\u7684\u4f18\u5148\u7ea7: \u5e76\u6ca1\u6709\u53d1\u751f\u4ec0\u4e48\u4e8b\u60c5.</li> </ul> </li> <li> <p>\u5982\u679c\u5f53\u524d\u7ebf\u7a0b\u4e0d\u6301\u6709\u9501</p> <ul> <li>\u66f4\u65b0 <code>priority</code></li> </ul> </li> </ul>"},{"location":"pintos/proj1/#lock_acquire","title":"<code>lock_acquire()</code>","text":"<ul> <li> <p>\u76f4\u63a5\u62ff\u5230</p> <ul> <li>\u8fd9\u9501\u4e5f\u6ca1\u4eba\u8981\u554a, \u62ff\u4e86.</li> <li>\u53ef\u80fd\u4e2d\u95f4\u88ab\u6253\u65ad\u8fc7, \u6240\u4ee5\u8bf4\u8ba9\u9501\u518d\u53bb\u66f4\u65b0\u4e00\u4e0b, \u770b\u770b\u6709\u6ca1\u6709\u597d\u5fc3\u4eba\u7684 donation</li> </ul> </li> <li> <p>\u6ca1\u62ff\u5230</p> <ul> <li>donate \u7ed9\u9501, \u8ba9\u9501\u66f4\u65b0 holder</li> <li>\u88ab block, \u7b49 semaphore</li> <li>\u7ec8\u4e8e\u653e\u51fa\u6765\u4e86, \u628a\u9501\u62ff\u8d70, \u66f4\u65b0\u4e00\u4e0b\u9501\u6536\u5230\u7684 priority, \u66f4\u65b0\u4e00\u4e0b\u81ea\u5df1\u7684 priority</li> </ul> </li> </ul> <p>\u95ee\u9898: \u6b7b\u9501?</p> <pre><code>\u4e24\u4e2a\u7ebf\u7a0b TA, TB, \u4e24\u4e2a\u9501 A, B.\n\nTA \u62ff\u9501 A, interrupt \u5207\u6362\u5230 TB\n\nTB \u62ff\u9501 B, interrupt \u5207\u6362\u5230 TA\n\nTA \u62ff\u9501 B, TA \u6350\u8d60\u7ed9 B, B \u6350\u8d60\u7ed9 TB, interrupt\n\nTB \u62ff\u9501 A, TB \u6350\u8d60\u7ed9 A, A \u6350\u8d60\u7ed9 TA, TA \u6350\u8d60\u7ed9 B...\n</code></pre> <p>\u89e3\u51b3?\u65b9\u5f0f: \u5bf9\u4e8e\u5d4c\u5957\u4f18\u5148\u7ea7\u6350\u8d60\u5173\u7cfb\u7684\u73af (From document \"If necessary, you may impose a reasonable limit on depth of nested priority donation, such as 8 levels.\"), \u52a0\u4e00\u4e2a\u4f20\u9012\u5c42\u6570?</p> <p>\u5916\u754c\u6b7b\u9501\u5b9e\u5728\u6ca1\u6cd5\u89e3\u51b3, \u4f46\u662f\u5c5e\u4e8e UB, \u4e0d\u89e3\u51b3\u4e5f\u884c. \u53ef\u4ee5\u8003\u8651\u52a0\u4e00\u4e2a\u68c0\u67e5\u662f\u5426\u6240\u6709\u7684\u7ebf\u7a0b\u90fd\u88ab block, \u5982\u679c\u5982\u6b64\u5c31\u7acb\u4e00\u4e2a flag \u6e05\u9664\u6240\u6709\u7684\u7ebf\u7a0b, \u7136\u540e PANIC.</p>"},{"location":"pintos/proj1/#lock_release","title":"<code>lock_release()</code>","text":"<ul> <li>\u4e0d\u88ab\u8fd9\u4e2a lock donate \u4e86, \u66f4\u65b0\u4e00\u4e0b\u81ea\u5df1\u7684 priority</li> </ul> <p><code>sema_up()</code></p> <p>\u95ee\u9898: \u88ab\u66f4\u65b0 priority \u7684 thread \u8fd8\u5728\u5806 / ready_list \u91cc\u9762, \u4f46\u662f\u63d2\u5165\u5df2\u7ecf\u53d1\u751f\u4e86, \u8be5 heap_up / heap_down?</p> <p>\u89e3\u51b3?\u65b9\u5f0f: \u5728\u5b8c\u6210\u4ece\u53f6\u5b50\u8282\u70b9\u5230\u6839\u8282\u70b9\u7684 donation \u4e4b\u540e, \u7981\u7528\u4e2d\u65ad\u7136\u540e \\(O(n)\\) \u5efa\u5806.</p>"},{"location":"pintos/proj1/#task-3","title":"Task 3","text":"<p>\u5728\u5168\u5c40 <code>bool</code> \u53d8\u91cf <code>thread_mlfqs</code> \u4e3a <code>true</code> \u7684\u65f6\u5019, \u542f\u7528 Multilevel Feedback Queue Scheduling, \u800c\u4e0d\u662f Task 2 \u7684\u57fa\u4e8e\u4f18\u5148\u7ea7\u7684 Round Robin \u8c03\u5ea6.</p>"},{"location":"pintos/proj1/#_2","title":"\u5b9e\u73b0\u5b9a\u70b9\u6570","text":"<p>\u5728 pintos \u5185\u6838\u4e2d\u6ca1\u6709\u6d6e\u70b9\u6570\u8fd0\u7b97, \u9700\u8981\u624b\u52a8\u5b9e\u73b0\u5b9a\u70b9\u6570\u6765\u5b8c\u6210 <code>load_avg</code>, <code>nice</code> \u7b49 MLFQS \u76f8\u5173\u503c\u7684\u8ba1\u7b97.</p> <p>\u4f7f\u7528 32 \u4f4d <code>int</code> \u4fdd\u5b58\u4e00\u4e2a\u5b9a\u70b9\u6570, \u4ee4 <code>x</code> \u8868\u793a\u5b9e\u6570 <code>x / (2^14)</code>, \u5373\u4f7f\u7528\u6700\u4f4e 14 \u4f4d\u5b58\u50a8\u5206\u6570.</p>"},{"location":"pintos/proj1/#nice","title":"\u66f4\u6539 nice","text":"<p>nice \u53ea\u6765\u81ea\u5916\u754c\u4f20\u5165 / \u4ece parent thread \u7ee7\u627f, \u4fee\u6539\u540e\u66f4\u65b0\u4f18\u5148\u7ea7\u5373\u53ef.</p>"},{"location":"pintos/proj1/#priority_1","title":"\u8ba1\u7b97 priority","text":"\\[ priority = PRI\\_MAX - \\dfrac{1}{4} recent\\_cpu - 2 \\cdot nice \\] <p>\u9700\u8981\u63a7\u5236\u8303\u56f4\u4e0d\u8d85\u8fc7 <code>PRI_MIN</code> \u5230 <code>PRI_MAX</code>.</p>"},{"location":"pintos/proj1/#recent_cpu","title":"\u8ba1\u7b97 recent_cpu","text":"\\[ recent\\_cpu = \\dfrac{2 \\cdot load\\_avg}{2 \\cdot load\\_avg + 1} \\cdot recent\\_cpu + nice \\]"},{"location":"pintos/proj1/#load_avg","title":"\u8ba1\u7b97 load_avg","text":"<p><code>load_avg</code> \u662f\u5168\u5c40\u7684, \u4e0d\u662f\u67d0\u4e2a\u7ebf\u7a0b\u7684\u5c5e\u6027.</p> \\[ load\\_avg = \\dfrac{59}{60} load\\_avg + \\dfrac{1}{60} ready\\_thread \\] <p>\\(ready_thread\\) \u4ee3\u8868\u6b63\u5728\u8fd0\u884c/\u5c31\u7eea\u7684\u7ebf\u7a0b\u6570\u91cf.</p>"},{"location":"pintos/proj2/","title":"Project 2: User Program","text":"<p>No plagiarism</p> <p>If you are enrolled in CS130, you may not copy code from this repository.</p> <p>\u6025\u4e86\u6025\u4e86\u6025\u4e86</p> <p>\u5f3a\u70c8\u5efa\u8bae\u4ece\u672a\u4fee\u6539\u7684\u6846\u67b6\u4ee3\u7801\u7248\u672c\u5f00\u59cb\u5199 Project 2, \u7531\u4e8e Project 1 \u6d89\u53ca\u5230\u5bf9 <code>thread</code>, <code>semaphore</code>, <code>lock</code> \u7b49\u7684\u4fee\u6539, \u53ef\u80fd\u5728 Project 2 \u5bfc\u81f4\u672a\u77e5\u9519\u8bef.</p> <p>Overview</p> <ul> <li>Task1 : print termination messages</li> <li>Task2 : argument passing</li> <li>Task3 : system calls</li> <li>Task4 : deny writes to executables</li> </ul>"},{"location":"pintos/proj2/#_1","title":"\u8c03\u8bd5","text":"<p>\u4e3a\u4e86\u5c06\u53ef\u6267\u884c\u6587\u4ef6\u5199\u5165 pintos \u7684\u865a\u62df\u786c\u76d8, \u9700\u8981\u6dfb\u52a0\u53c2\u6570 <code>-p tests/userprog/filename -a filename</code>, \u6bcf\u4e2a\u6587\u4ef6\u589e\u52a0\u4e00\u7ec4\u4e0a\u8ff0\u5f62\u5f0f\u7684\u53c2\u6570.</p>"},{"location":"pintos/proj2/#_2","title":"\u5206\u6790","text":"<p>\u5728 <code>tests/userprog/Make.tests</code> \u5185\u6709\u6b64 project \u7684\u81ea\u6d4b\u6570\u636e\u70b9.</p> <pre><code>tests/userprog/args-none_SRC = tests/userprog/args.c\ntests/userprog/args-single_SRC = tests/userprog/args.c\ntests/userprog/args-multiple_SRC = tests/userprog/args.c\ntests/userprog/args-many_SRC = tests/userprog/args.c\ntests/userprog/args-dbl-space_SRC = tests/userprog/args.c\n</code></pre> <p>\u524d\u9762\u51e0\u4e2a\u6d4b\u8bd5\u7528\u5230\u4e86 <code>args.c</code></p> <pre><code>test_name = \"args\";\n\nmsg (\"begin\");\nmsg (\"argc = %d\", argc);\nfor (i = 0; i &lt;= argc; i++)\nif (argv[i] != NULL)\n    msg (\"argv[%d] = '%s'\", i, argv[i]); // \u9700\u8981\u628a arg \u5206\u9694\u5f00\nelse\n    msg (\"argv[%d] = null\", i);\nmsg (\"end\");\n\nreturn 0; // \u6211\u8be5\u600e\u4e48\u5f97\u5230\u4f60, \u4eb2\u7231\u7684\u8fd4\u56de\u503c?\n</code></pre> <p>\u4e3b\u8981\u5185\u5bb9\u4e3a\u6253\u5370\u547d\u4ee4\u884c\u53c2\u6570, \u4e5f\u5c31\u662f\u9700\u8981\u5b9e\u73b0\u4e3a user program \u4f20\u53c2.</p> <p>\u5206\u6790\u8c03\u7528\u8fc7\u7a0b: \u5728 <code>threads/init.c</code> \u4e2d, <code>main() -&gt; run_actions() -&gt; run_task() -&gt; process_wait (process_execute (task))</code></p> <p>\u770b\u4e00\u4e0b <code>process_wait()</code></p> <pre><code>int\nprocess_wait (tid_t child_tid UNUSED) \n{\n  return -1;\n}\n</code></pre> <p>\u6309\u7167\u6ce8\u91ca\u91cc\u7684\u5185\u5bb9, \u8fd9\u4e2a\u51fd\u6570\u4f5c\u7528\u662f\u7b49\u5f85\u7f16\u53f7 <code>child_tid</code> \u7ebf\u7a0b\u7684\u8fd0\u884c\u7ed3\u679c, \u5982\u679c \u90a3\u4e2a\u7ebf\u7a0b\u88ab\u7cfb\u7edf\u4e2d\u6b62/\u4f20\u5165\u7684 <code>tid</code> \u4e0d\u5b58\u5728/\u4f20\u5165\u7684 <code>tid</code> \u4ee3\u8868\u7684\u8fdb\u7a0b\u4e0d\u662f\u76ee\u524d\u7ebf\u7a0b\u7684\u5b50\u8fdb\u7a0b/\u8fd9\u4e2a\u7ebf\u7a0b\u5df2\u7ecf\u6709\u4e00\u4e2a <code>process_wait()</code> \u5728\u7b49\u5f85\u5b83 \u5219\u8fd4\u56de <code>-1</code>, \u5426\u5219\u8fd4\u56de\u5b83\u901a\u8fc7 <code>exit</code> \u4f20\u9012\u7684\u8fd4\u56de\u503c.</p>"},{"location":"pintos/proj2/#_3","title":"\u6587\u4ef6\u7cfb\u7edf\u9650\u5236","text":"<ul> <li>\u53ef\u80fd\u5e76\u53d1\u8bbf\u95ee\u6587\u4ef6, \u8003\u8651\u52a0\u9501</li> <li>\u6587\u4ef6\u5927\u5c0f\u56fa\u5b9a, \u63a7\u5236\u6587\u4ef6\u540d\u957f\u5ea6\u4e0d\u8d85\u8fc7 14 \u5b57\u7b26</li> <li>\u6ca1\u6709\u865a\u62df\u5185\u5b58, \u6587\u4ef6\u5fc5\u987b\u5360\u7528\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58, \u5408\u7406\u5206\u914d\u548c\u56de\u6536</li> </ul>"},{"location":"pintos/proj2/#task-1","title":"Task 1","text":"<p>\u5728\u4e00\u4e2a\u8fdb\u7a0b\u9000\u51fa\u65f6\u8f93\u51fa\u4e2d\u6b62\u4fe1\u606f (\u540d\u79f0, exit code)</p> <p>\u5728 <code>process.c</code> \u5185\u67e5\u627e\u53d1\u73b0\u6709\u4e00\u4e2a <code>process_exit()</code>, \u7528\u4e8e\u91ca\u653e\u4e00\u4e2a\u8fdb\u7a0b\u5206\u914d\u7684\u8d44\u6e90, \u8fd9\u4e2a\u51fd\u6570\u5728 <code>thread_exit()</code> \u88ab\u8c03\u7528, \u7531\u4e8e pintos \u7684\u4e00\u4e2a\u8fdb\u7a0b\u4e0b\u6ca1\u6709\u591a\u7ebf\u7a0b, \u6240\u4ee5\u76f4\u63a5\u7528\u8be5\u7ebf\u7a0b\u7684 exit \u4ee3\u8868.</p> <p>\u4e8e\u662f\u9700\u8981\u5728 <code>process_exit()</code> \u5185\u52a0\u4e0a\u4fe1\u606f\u6253\u5370.</p> <p>\u8fdb\u7a0b\u540d\u79f0\u6765\u81ea\u7ebf\u7a0b\u540d\u79f0, \u5728 <code>process_excute()</code> \u5185\u6253\u5370, \u53d1\u73b0 <code>file_name</code> \u4e0d\u4ec5\u4f20\u5165\u4e86\u8981\u8fd0\u884c\u7684\u6587\u4ef6\u7684\u540d\u79f0, \u8fd8\u6709\u8fd0\u884c\u53c2\u6570, \u662f\u4e00\u884c\u5b8c\u6574\u7684\u6307\u4ee4, \u9700\u8981\u624b\u52a8\u6309\u7a7a\u683c\u5206\u79bb\u51fd\u6570\u540d\u548c\u4ee5\u7a7a\u683c (\u53ef\u80fd\u591a\u4e2a\u7a7a\u683c) \u5206\u9694\u5f00\u7684\u6bcf\u4e2a command line args.</p> <p><code>process_execute()</code> \u5185, <code>palloc_get_page(0)</code> \u83b7\u5f97\u4e86 kernel pool \u7684\u4e00\u4e2a page, \u5b58\u50a8\u5b8c\u6574\u7684\u547d\u4ee4, \u5728 <code>start_process()</code> \u4e2d <code>load()</code> \u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u5b8c\u6bd5\u540e\u5c06\u5176\u91ca\u653e, <code>thread</code> \u4e2d\u7684 <code>name</code> \u4f7f\u7528 <code>memcpy</code> \u590d\u5236\u5230\u5b57\u7b26\u6570\u7ec4, \u800c command line args \u9700\u8981\u76f4\u63a5\u538b\u5230\u6808\u91cc\u9762, \u6240\u4ee5\u8bf4\u53ef\u4ee5\u901a\u8fc7\u5728\u524d\u9762\u5206\u914d, \u5728 <code>start_process()</code> \u5185\u91ca\u653e\u7684\u5f62\u5f0f\u4e34\u65f6\u4fdd\u5b58\u547d\u4ee4\u884c\u8bed\u53e5.</p> <p>\u8fd9\u6837, \u5728 <code>process_execute()</code> \u65f6\u76f4\u63a5\u5206\u5272\u51fa\u53ef\u6267\u884c\u6587\u4ef6\u540d\u79f0, \u4f5c\u4e3a\u7ebf\u7a0b\u540d\u79f0\u5373\u53ef.</p> <p>\u4f60\u8bf4\u5f97\u5bf9, \u4f46\u662f\u6211\u8fd4\u56de\u503c\u5462?</p> <p>\u505a\u4e0d\u4e86\u4e00\u70b9, \u770b\u4e0b\u4e00\u4e2a task</p>"},{"location":"pintos/proj2/#task-2","title":"Task 2","text":"<p>\u4e3a  user program \u4f20\u53c2.</p> <p>\u9996\u5148\u4e3a\u4e86\u8ba9 progress \u8dd1\u8d77\u6765, \u628a <code>progress_wait()</code> \u6539\u6210 <code>while(1)</code> \u6b7b\u5faa\u73af, \u9632\u6b62\u88ab\u7ec8\u6b62, \u4ee5\u540e\u518d\u5b9e\u73b0\u6b63\u5e38\u7684 wait.</p> <p>\u770b\u5b8c\u6587\u6863\u7684\u4f8b\u5b50:</p> Address Name Data Type 0xbfffffc argv[3][...] bar\\0 char[4] 0xbfffff8 argv[2][...] foo\\0 char[4] 0xbfffff5 argv[1][...] -l\\0 char[3] 0xbffffed argv[0][...] /bin/ls\\0 char[8] 0xbffffec word-align 0 uint8_t 0xbffffe8 argv[4] 0 char * 0xbffffe4 argv[3] 0xbfffffc char * 0xbffffe0 argv[2] 0xbfffff8 char * 0xbffffdc argv[1] 0xbfffff5 char * 0xbffffd8 argv[0] 0xbffffed char * 0xbffffd4 argv 0xbffffd8 char ** 0xbffffd0 argc 4 int 0xbffffcc return address 0 void (*)() <p>\u6307\u9488\u6700\u5f00\u59cb\u5728 <code>PHYS_BASE</code> \u7684\u4f4d\u7f6e, \u9996\u5148\u5806\u5165\u6bcf\u4e2a <code>argv</code> \u7684\u4e32\u7684\u5185\u5bb9, \u5806\u7684\u65f6\u5019\u6307\u9488\u5411\u5730\u5740\u8f83\u5c0f\u7684\u65b9\u5411\u79fb\u52a8, \u4fdd\u8bc1\u6bcf\u4e2a\u4e32\u5728\u5185\u5b58\u4e0a\u987a\u5e8f, \u4e14\u5305\u542b\u4ee3\u8868\u5b57\u7b26\u4e32\u7ed3\u675f\u7684 <code>\\0</code>, \u4e32\u4e4b\u95f4\u987a\u5e8f\u65e0\u6240\u8c13, \u4fdd\u5b58\u5730\u5740\u6307\u9488.</p> <p>\u7136\u540e\u8fdb\u884c\u5bf9\u9f50.</p> <p>\u7136\u540e\u628a <code>argv[i]</code> \u7684\u5730\u5740, \u4ee5\u53ca <code>argv</code> \u7684\u5730\u5740\u538b\u5165\u6808, \u6700\u540e\u538b\u5165 <code>argc</code> \u548c <code>return address</code>.</p> <p>\u6b64\u65f6\u4f20\u53c2\u7ed3\u675f, \u6c47\u7f16\u8df3\u8f6c\u540e\u8c03\u7528</p> <pre><code>void\n_start (int argc, char *argv[])\n{\n  exit (main (argc, argv));\n}\n</code></pre> <p>\u5f00\u59cb\u8fd0\u884c user program. \u6b64\u65f6\u4f1a\u8c03\u7528 <code>syscall</code>, \u8fdb\u5165 <code>syscall_handler</code> \u73af\u8282.</p>"},{"location":"pintos/proj2/#task-3","title":"Task 3","text":"<p>\u5b9e\u73b0 13 \u79cd system call.</p> <p>system call \u5c5e\u4e8e\u5185\u90e8\u4e2d\u65ad, \u548c\u4e4b\u524d\u7684 timer interrupt \u7b49 CPU \u5916\u8bbe\u5907\u9020\u6210\u7684\u4e2d\u65ad\u4e0d\u540c.</p> <p>\u9996\u5148\u67e5\u770b handler \u5982\u4f55\u5904\u7406 system call.</p> <p><code>syscall_init()</code> \u4fdd\u8bc1\u4e86\u5728\u7a0b\u5e8f\u4f7f\u7528 <code>int 0x30</code> \u4e2d\u65ad\u65f6\u8c03\u7528 <code>syscall_handler()</code>, \u67e5\u770b <code>src/lib/user/syscall.c</code> \u5b8f, \u4f7f\u7528\u6c47\u7f16\u8fdb\u884c\u538b\u6808, handler \u9700\u8981\u4ece <code>intr_frame</code> \u83b7\u53d6\u4fe1\u606f.</p>"},{"location":"pintos/proj2/#_4","title":"\u786e\u5b9a\u8c03\u7528\u79cd\u7c7b","text":"<p>\u5b8f\u6709 <code>syscall0</code>, <code>syscall1</code>, <code>syscall2</code>, <code>syscall3</code> \u56db\u79cd, \u538b\u6808 syscall \u7c7b\u578b\u548c\u53c2\u6570, \u5219\u53ef\u4ee5\u4ece <code>esp</code> \u6307\u9488\u83b7\u53d6 system call \u7c7b\u578b, \u7136\u540e\u518d\u5411\u9ad8\u5730\u5740\u79fb\u52a8 <code>esp</code> \u83b7\u53d6\u540e\u9762\u7684\u53c2\u6570.</p> <p><code>syscall_id = *(int *)f-&gt;esp;</code></p>"},{"location":"pintos/proj2/#halt","title":"halt","text":"<p>\u65e0\u53c2\u6570, \u76f4\u63a5\u5173\u673a.</p>"},{"location":"pintos/proj2/#exitexecwait","title":"exit\uff0cexec\uff0cwait","text":"<p>\u95ee\u9898: \u8fdb\u7a0b\u5728\u88ab wait \u4e4b\u524d\u8c03\u7528 exit</p> <p>\u9700\u8981\u9002\u5f53\u4fdd\u5b58\u4e00\u4e2a\u8fdb\u7a0b\u6240\u6709\u5b50\u8fdb\u7a0b\u7684 exit status. \u5982\u679c\u5c06 exit status \u4fdd\u5b58\u5728 <code>struct thread</code> \u91cc\u9762, \u5728 <code>thread_exit()</code> \u65f6, \u4f1a\u91ca\u653e\u8fd9\u4e2a\u7ed3\u6784, \u65e0\u6cd5\u4fdd\u5b58 exit status.</p> <p>\u53ef\u80fd\u6709\u5982\u4e0b\u51e0\u79cd\u60c5\u51b5\uff1a</p> <ol> <li>\u5b50\u8fdb\u7a0b\u8c03\u7528 <code>exit</code>\uff0c\u7136\u540e\u7236\u8fdb\u7a0b\u8c03\u7528 <code>wait</code></li> <li>\u7236\u8fdb\u7a0b\u5728\u5b50\u8fdb\u7a0b\u5b8c\u6210\u521d\u59cb\u5316\u4e4b\u524d\u8c03\u7528 <code>wait</code>\uff0c\u8bbf\u95ee\u4e86\u672a\u521d\u59cb\u5316\u7684\u5185\u5b58</li> <li>\u5b50\u8fdb\u7a0b\u521b\u5efa\u8fc7\u7a0b\u4e2d\uff0c\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6/\u5206\u914d\u5185\u5b58\u5931\u8d25\uff0c\u7236\u8fdb\u7a0b\u8c03\u7528 <code>wait</code> \u9700\u8981\u5f97\u5230\u5408\u6cd5\u7684\u8fd4\u56de\u503c</li> <li>\u5b50\u8fdb\u7a0b\u5df2\u7ecf\u88ab <code>wait</code>\uff0c\u7236\u8fdb\u7a0b\u518d\u6b21\u8c03\u7528 <code>wait</code>\uff0c\u5e94\u8be5\u8fd4\u56de -1</li> <li>\u7236\u8fdb\u7a0b\u7ec8\u6b62\u65f6\u5b50\u8fdb\u7a0b\u7684\u8fd4\u56de\u60c5\u51b5\u4e0d\u518d\u88ab\u9700\u8981</li> </ol> <p>\u8003\u8651\u4f7f\u7528 <code>thread/malloc</code> \u5185\u5b9e\u73b0\u7684 <code>malloc()</code>, \u8fd9\u4e2a\u51fd\u6570\u5728 kernel pool \u5185\u5206\u914d\u5185\u5b58, \u4fdd\u8bc1\u4e86\u7236\u8fdb\u7a0b, \u5b50\u8fdb\u7a0b\u90fd\u53ef\u4ee5\u5728\u5185\u6838\u6001\u8bbf\u95ee\u5230, \u4e14\u5728\u8fdb\u7a0b\u7ec8\u7ed3\u65f6\u4e0d\u4f1a\u88ab\u7acb\u5373\u91ca\u653e, \u53ef\u4ee5\u7b49\u5f85\u7236\u8fdb\u7a0b\u53bb\u91ca\u653e.</p> <p>\u5728\u5206\u914d\u5185\u5bb9\u8f83\u5c11\u65f6, \u907f\u514d\u4f7f\u7528 <code>palloc_get_page(0)</code></p> <ol> <li>\u5728 <code>thread_create()</code> \u65f6, \u4e3a\u5b50\u8fdb\u7a0b\u5206\u914d\u5185\u5b58, \u8fd4\u56de <code>tid</code>\uff0c\u521d\u59cb\u5316\u7528\u4e8e\u8ba9\u7236\u8fdb\u7a0b\u7b49\u5f85\u52a0\u8f7d\u7684\u4e00\u4e2a\u4fe1\u53f7\u91cf</li> <li>\u7236\u8fdb\u7a0b <code>sema_down()</code> \u7b49\u5f85\u5b50\u8fdb\u7a0b\u52a0\u8f7d\u5b8c\u6bd5</li> <li>\u5728\u5b50\u8fdb\u7a0b\u52a0\u8f7d\u8fc7\u7a0b\u4e2d\uff0c\u4fdd\u5b58\u52a0\u8f7d\u60c5\u51b5\uff0c\u4fdd\u8bc1\u4e2d\u9014\u52a0\u8f7d\u5931\u8d25\u7136\u540e <code>sema_up()</code> \u53ef\u4ee5\u8ba9\u7236\u8fdb\u7a0b\u5f97\u77e5\u52a0\u8f7d\u5931\u8d25</li> <li>\u4e3a\u4e86\u5b9e\u73b0 <code>wait</code>\uff0c\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u521b\u5efa\u5b50\u8fdb\u7a0b\u5217\u8868\uff0c\u5217\u8868\u5185\u5143\u7d20\u8d1f\u8d23\u4fdd\u5b58\u5b50\u8fdb\u7a0b\u7684 <code>tid</code> \u548c <code>exit status</code>\uff0c\u4e14\u5305\u542b\u4e00\u4e2a\u4fe1\u53f7\u91cf\uff0c\u7528\u4e8e\u7236\u8fdb\u7a0b\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7ed3\u675f\uff0c\u5728 <code>wait</code> \u65f6\uff0c\u7236\u8fdb\u7a0b <code>sema_up()</code>\uff0c\u5728\u5b50\u8fdb\u7a0b\u7ed3\u675f\u65f6\uff0c\u82e5\u7236\u8fdb\u7a0b\u5b58\u6d3b\u5219\u627e\u5230\u7236\u8fdb\u7a0b\u7684\u5217\u8868\u91cc\u9762\u5bf9\u5e94\u5143\u7d20\uff0c\u66f4\u65b0 <code>exit status</code>\uff0c\u7136\u540e <code>sema_up()</code> \u901a\u77e5\u7236\u8fdb\u7a0b</li> <li>\u8fdb\u7a0b\u7ec8\u6b62\u65f6\uff0c\u91ca\u653e\u5b50\u8fdb\u7a0b\u5217\u8868</li> </ol>"},{"location":"pintos/proj2/#syscall","title":"\u6587\u4ef6\u7cfb\u7edf\u76f8\u5173 syscall","text":"<p>\u5305\u542b <code>create</code>, <code>remove</code>, <code>open</code>, <code>filesize</code>, <code>read</code>, <code>write</code>, <code>seek</code>, <code>tell</code>, <code>close</code></p> <p>\u5b9e\u73b0\u4e00\u5957\u4e3a\u6bcf\u4e2a\u8fdb\u7a0b\u7ba1\u7406\u6587\u4ef6\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\uff08file descriptor\uff09\u4f53\u7cfb\u3002\u5728\u6253\u5f00\u6587\u4ef6\u65f6\u5206\u914d <code>fd</code>\uff0c\u6ce8\u610f <code>fd</code> \u4e0d\u80fd\u4e3a 0, 1\uff0c\u8fd9\u4e24\u4e2a\u6587\u4ef6\u63cf\u8ff0\u7b26\u7528\u4e8e\u6807\u51c6\u8f93\u5165\u8f93\u51fa\u3002</p> <p>\u5728\u8fdb\u7a0b\u7ec8\u6b62\u65f6\uff0c\u5173\u95ed\u6240\u6709\u6587\u4ef6\uff0c\u6e05\u7a7a\u6587\u4ef6\u63cf\u8ff0\u7b26\u8868\u3002</p>"},{"location":"pintos/proj2/#_5","title":"\u7981\u6b62\u8bbf\u95ee\u975e\u6cd5\u5730\u5740","text":"<p>\u6211\u91c7\u7528\u4e86\u6587\u6863\u91cc\u9762\u63d0\u5230\u7684\uff1a\u5728\u5b9e\u9645\u8bbf\u95ee\u4e4b\u524d\uff0c\u8bbf\u95ee\u6bcf\u4e2a\u53ef\u80fd\u88ab\u7528\u5230\u7684\u5730\u5740\uff0c\u5982\u679c\u6709\u975e\u6cd5\u8bbf\u95ee\uff0c\u89e6\u53d1 page fault\uff0c\u7136\u540e\u5728 page fault handler \u91cc\u9762\u5904\u7406\u3002</p> <p>\u8bbf\u95ee\u7528\u5230\u7684\u51fd\u6570\u5728\u6587\u6863\u91cc\u9762\u5df2\u7ecf\u7ed9\u51fa\u3002\u5728 syscall \u9700\u8981\u4efb\u4f55\u8bfb/\u5199\u64cd\u4f5c\u65f6\uff0c\u5148\u5168\u90e8\u8bbf\u95ee\u4e00\u904d\uff08\u5b57\u7b26\u4e32\u5219\u9700\u8981\u8bbf\u95ee\u6bcf\u4e2a\u5b57\u7b26\uff09\uff0c\u7136\u540e\u518d\u8fdb\u884c\u64cd\u4f5c\u3002</p> <p>\u9519\u8bef\u7684\u5730\u5740\u8bbf\u95ee\u4f1a\u89e6\u53d1 page fault\uff0c\u6240\u6709\u7684 page fault \u4f1a\u88ab <code>userprog/excepion.c</code> \u4e2d\u5bf9\u5e94\u7684 handler \u5904\u7406\uff0c\u6ce8\u610f\u5230\u539f\u672c\u7684\u7b56\u7565\u662f\u4f7f\u7528 <code>thread_exit()</code>\uff0c\u73b0\u5728\u5b9e\u73b0\u4e86\u7528\u6237\u8fdb\u7a0b\uff0c\u6539\u4e3a\u4f7f\u7528 exit system call\u3002\u6839\u636e <code>page_fault()</code> \u91cc\u9762\u63d0\u4f9b\u7684 <code>not_present</code>\uff0c<code>write</code>\uff0c<code>user</code> \u4e09\u4e2a flag \u9009\u62e9\u4e0d\u540c\u7684\u5904\u7406\u65b9\u5f0f\u5373\u53ef\u3002</p>"},{"location":"pintos/proj2/#task-4","title":"Task 4","text":"<p>\u62d2\u7edd\u7528\u6237\u5199\u5165\u53ef\u6267\u884c\u6587\u4ef6.</p> <p>\u5728 <code>load</code> \u52a0\u8f7d\u5b8c\u6210\u540e\u4f7f\u7528 <code>filesys</code> \u4e0b\u76f8\u5e94\u4ee3\u7801\u62d2\u7edd\u5199\u5165\u3002</p> <p>\u9996\u5148\u6b64\u65f6\u4efb\u4f55\u6d89\u53ca\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u4ee3\u7801\u90fd\u5e94\u8be5\u4e92\u65a5\uff0c\u4e8e\u662f\u6574\u4f53\u52a0\u4e00\u4e2a <code>filesys_lock</code> \u4fdd\u62a4, \u5728 <code>filesys/filesys.h</code> \u5185 <code>extern struct lock filesys_lock;</code> \u65b9\u4fbf\u8c03\u7528.</p>"},{"location":"pintos/proj3/","title":"Project 3: Virtual Memory","text":"<p>No plagiarism</p> <p>If you are enrolled in CS130, you may not copy code from this repository. Project 3 \u5f3a\u8c03\u8bbe\u8ba1, \u5177\u4f53\u5b9e\u73b0\u56e0\u4eba\u800c\u5f02. \u5982\u679c\u4f60\u771f\u7684\u6ca1\u6709\u5934\u7eea, \u53ef\u4ee5\u5148\u770b\u770b design document \u6a21\u677f.</p> <p>\u6025\u4e86\u6025\u4e86\u6025\u4e86</p> <p>Project 3 \u57fa\u4e8e Project 2, \u5e0c\u671b\u4f60\u7684 Project 2 \u8db3\u591f robust \u4e14\u6709\u5408\u9002\u7684\u975e\u6cd5\u5730\u5740\u68c0\u6d4b.</p> <p>Overview</p> <ul> <li>Task 1 : paging</li> <li>Task 2 : stack growth</li> <li>Task 3 : memory mapping files</li> <li>Task 4 : accessing user memory</li> </ul>"},{"location":"pintos/proj3/#_1","title":"\u6587\u4ef6\u7cfb\u7edf\u9650\u5236\u4f9d\u7136\u5b58\u5728","text":"<ul> <li>\u53ef\u80fd\u5e76\u53d1\u8bbf\u95ee\u6587\u4ef6, \u8003\u8651\u52a0\u9501</li> <li>\u6587\u4ef6\u5927\u5c0f\u56fa\u5b9a, \u63a7\u5236\u6587\u4ef6\u540d\u957f\u5ea6\u4e0d\u8d85\u8fc7 14 \u5b57\u7b26</li> </ul>"},{"location":"pintos/proj3/#_2","title":"\u5206\u6790","text":"<p>\u7a7a\u554a, \u5f88\u7a7a\u554a (\u6307 vm \u6587\u4ef6\u5939).</p> <p><code>Make.vars</code> \u91cc\u9762\u6dfb\u52a0\u4e86\u5b8f\u5b9a\u4e49 <code>VM</code>, \u53ef\u4ee5\u50cf\u4e4b\u524d\u7684 <code>#ifdef USERPROG</code> \u4e00\u6837\u4f7f\u7528.</p> <p>\u65b0\u589e\u7684 <code>.c</code> \u6587\u4ef6\u9700\u8981\u5728 <code>Makefile.build</code> \u91cc\u9762\u6dfb\u52a0\u5230 <code>vm_SRC</code>.</p>"},{"location":"pintos/proj3/#virtual-address","title":"\u4ec0\u4e48\u662f virtual address","text":"<p>\u5bf9 virtual address \u7684\u652f\u6301\u662f\u4ece bare metal \u5f00\u59cb\u7684 (\u5230\u8fbe\u786c\u4ef6 (\u76f8\u5bf9\u6765\u8bf4\u6bd4\u8f83) \u5e95\u5c42! \u592a\u7f8e\u4e3d\u4e86 CPU, \u54ce\u5440\u8fd9\u4e0d DRAM \u5417, \u8fd8\u662f\u770b\u770b\u8fdc\u5904\u7684\u4e00\u751f\u4e00\u82af\u5427\u5bb6\u4eba\u4eec), \u56de\u770b pintos \u7684\u542f\u52a8\u8fc7\u7a0b, <code>start.S</code> \u91cc\u9762\u7684\u6c47\u7f16\u6700\u5f00\u59cb\u76f4\u63a5\u8bbf\u95ee\u7684\u662f\u7269\u7406\u5730\u5740, \u4f46\u662f\u5728\u542f\u52a8\u8fc7\u7a0b\u4e2d <code>movl %eax, %cr3</code> \u8bbe\u7f6e\u4e86 CR3 \u5bc4\u5b58\u5668, \u5373\u5728\u8fdb\u5165\u4fdd\u62a4\u6a21\u5f0f\u4e4b\u540e, \u4e00\u5207 \"\u6309\u7167\u5730\u5740\u8bbf\u95ee\" \u5b9e\u9645\u4e0a\u90fd\u662f\u8bbf\u95ee\u865a\u62df\u5730\u5740.</p> <pre><code>+------------------+  &lt;- 0xFFFFFFFF (4GB)\n|      32-bit      |\n|  memory mapped   |\n|     devices      |\n|                  |\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n/\\/\\/\\/\\/\\/\\/\\/\\/\\/\\\n|                  |\n|      Unused      |\n|                  |\n+------------------+  &lt;- depends on amount of RAM\n|                  |\n|                  |\n| Extended Memory  |\n|                  |\n|                  |\n+------------------+  &lt;- 0x00100000 (1MB)\n|     BIOS ROM     |\n+------------------+  &lt;- 0x000F0000 (960KB)\n|  16-bit devices, |\n|  expansion ROMs  |\n+------------------+  &lt;- 0x000C0000 (768KB)\n|   VGA Display    |\n+------------------+  &lt;- 0x000A0000 (640KB)\n|  pintos kernel   |\n+------------------+  &lt;- 0x00020000 (128KB)\n|  page tables     |\n|  for startup     |\n+------------------+  &lt;- 0x00010000 (64KB)\n|  page directory  |\n|  for startup     |\n+------------------+  &lt;- 0x0000f000 (60KB)\n|  initial kernel  |\n|   thread struct  |\n+------------------+  &lt;- 0x0000e000 (56KB)\n|        /         |\n+------------------+  &lt;- 0x00007e00 (31.5KB)\n|   pintos loader  |\n+------------------+  &lt;- 0x00007c00 (31KB)\n|        /         |\n+------------------+  &lt;- 0x00000600 (1536B)\n|     BIOS data    |\n+------------------+  &lt;- 0x00000400 (1024B)\n|     CPU-owned    |\n+------------------+  &lt;- 0x00000000\n</code></pre> <p>\u9664\u4e86\u4e0a\u9762\u8fd9\u5f20\u56fe\u7684 \"0x.....\" \u662f\u786e\u5b9e\u5728\u786c\u4ef6\u91cc\u9762\u7684\u5730\u5740, \u5176\u4ed6\u90fd\u662f\u865a\u62df\u5730\u5740 (\u8fdb\u5165\u4fdd\u62a4\u6a21\u5f0f\u4e86).</p> <p>\u7136\u540e\u8fd9\u5c42\u5730\u5740\u662f start.S \u521b\u9020\u7684\u53ea\u6620\u5c04\u4e86\u51e0 MB \u7684 page directory \u7684\u72b6\u6001, \u5728\u9ad8\u7ea7\u521d\u59cb\u5316\u8fc7\u7a0b\u4e2d, <code>paging_init ()</code> \u51fd\u6570\u521d\u59cb\u5316\u4e86\u66f4\u5b8c\u6574\u7684 page directory (<code>init_page_dir</code>), \u7136\u540e\u4fee\u6539 CR3 \u5bc4\u5b58\u5668, \u4f7f\u5f97 CPU \u4ece\u6b64\u5f00\u59cb\u4f7f\u7528\u65b0\u7684 page directory.</p> <p>\u8fd9\u4e2a page directory \u786e\u5b9a\u4e86 kernel virtual memory \u5230 physical memory \u7684\u6620\u5c04, \u5185\u6838\u7684 virtual memmory \u8303\u56f4\u4e3a <code>PHYS_BASE</code> \u5230 <code>0xFFFFFFFF</code> (4 GB), \u4e14\u5185\u6838 virtual memory \u548c physical memory \u6620\u5c04\u5173\u7cfb\u56fa\u5b9a\u4e3a <code>vaddr = paddr + PHYS_BASE</code>.</p> <p>\u7531\u4e8e CPU \u5fc5\u987b\u8bfb\u53d6 page table \u7684\u7269\u7406\u5730\u5740, \u4f46 x86 \u6ca1\u6709\u63d0\u4f9b\u76f4\u63a5\u8bfb\u5199\u7269\u7406\u5730\u5740\u7684\u6307\u4ee4, \u6240\u4ee5\u9700\u8981 kernel virtual memory \u7684\u8fd9\u79cd\u7ebf\u6027\u6620\u5c04\u5173\u7cfb, \u4ee5\u5b9e\u73b0\u4fee\u6539 page directory / page table \u7684\u76ee\u7684.</p> <p>\u5728 kernel \u7684 1 GB \u5185\u5b58\u4e2d, \u8fd8\u4fdd\u5b58\u4e86 page \u5206\u914d\u7684\u4fe1\u606f (bitmap), \u4ee5\u6b64\u5b9e\u73b0\u4e86 palloc get/free \u7684\u529f\u80fd.</p> <p>\u73b0\u5728\u7684 virtual memory \u5e03\u5c40\u5982\u4e0b:</p> <pre><code>   (4 GB)    +----------------------------------+\n             |                                  |\n             |       kernel virtual memory      |\n             |                                  |\n   PHYS_BASE +----------------------------------+\n             |            user stack            |\n             |                 |                |\n             |                 |                |\n             |                 V                |\n             |          grows downward          |\n             |                                  |\n             |         LOL, no heap memory      |\n             |                                  |\n             |                                  |\n             |           grows upward           |\n             |                 ^                |\n             |                 |                |\n             |                 |                |\n             +----------------------------------+\n             | uninitialized data segment (BSS) |\n             +----------------------------------+\n             |     initialized data segment     |\n             +----------------------------------+\n             |           code segment           |\n  0x08048000 +----------------------------------+\n             |                                  |\n             |                                  |\n             |                                   |\n             |                                  |\n             |                                  |\n           0 +----------------------------------+\n</code></pre> <p>\u5185\u6838\u5185\u5b58\u5168\u5c40\u5171\u4eab, \u5728 project 2 \u4f7f\u7528\u7684 <code>thread/malloc.c</code> \u91cc\u9762\u5b9e\u73b0\u7684 <code>malloc()</code>, <code>free()</code> \u548c <code>palloc_get_page (0)</code> \u90fd\u662f\u4ece\u6b64\u90e8\u5206\u5185\u5b58\u4e2d\u5206\u914d.</p> <p>\u5728 <code>userprog/pagedir.c pagedir_activate()</code> \u901a\u8fc7\u5185\u8054\u6c47\u7f16\u4fee\u6539 <code>CR3</code> \u5bc4\u5b58\u5668 (\u82e5\u8be5\u8fdb\u7a0b\u672a\u8bbe\u7f6e page directory, \u5219\u4f7f\u7528\u53ea\u6620\u5c04\u4e86 kernel virtual memory \u7684 <code>init_page_dir</code>), \u66f4\u6539 CPU \u67e5\u627e\u865a\u62df\u5185\u5b58\u65f6\u4f7f\u7528\u7684 page directory, \u6765\u5b9e\u73b0\u5207\u6362\u7ebf\u7a0b\u65f6\u7684\u5185\u5b58\u5207\u6362.</p> <p>\u6240\u6709\u7684\u65b0\u7684 page directory \u90fd\u662f\u5728 <code>init_page_dir</code> \u57fa\u7840\u4e0a\u52a0\u5165\u4e86\u7528\u6237\u5185\u5b58\u7684\u6620\u5c04, \u4fdd\u8bc1\u53ef\u4ee5\u8bbf\u95ee\u5185\u6838\u5185\u5b58\u548c\u7528\u6237\u5185\u5b58.</p> <p>page directory \u4fdd\u8bc1\u4e86\u901a\u8fc7 page table \u7f16\u53f7\u53ef\u4ee5\u627e\u5230\u5bf9\u5e94 page table.</p> <p>\u5728\u4e00\u4e2a page \u88ab\u5207\u6362\u51fa\u53bb\u540e, \u4f7f\u7528\u8fd9\u4e2a page \u7684\u8fdb\u7a0b\u53ef\u80fd\u53c8\u8981\u7528\u5230\u8fd9\u4e2a page, \u9700\u8981\u628a\u5207\u51fa\u7684 page \u653e\u5230 disk \u4e0a, \u4ee5\u4fbf\u5728\u9700\u8981\u65f6\u518d\u6b21\u8f7d\u5165\u5230\u5185\u5b58.</p> <p>user virtual memory \u5e03\u5c40\u548c C \u7a0b\u5e8f\u5185\u5b58\u5e03\u5c40\u76f8\u4f3c, \u6808\u533a\u4ece\u9ad8\u5730\u5740\u5411\u4f4e\u5730\u5740\u589e\u957f, \u4f46\u662f\u4e0d\u652f\u6301\u52a8\u6001\u5206\u914d\u5806\u533a, \u5168\u5c40\u533a\u5728\u4f4e\u5730\u5740, \u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u65f6\u88ab\u521d\u59cb\u5316.</p> <p>\u7531\u4e8e\u6bcf\u4e2a page \u7684\u5927\u5c0f\u90fd\u76f8\u540c, \u4e14\u6bcf\u4e2a page \u90fd\u662f\u5bf9\u9f50\u7684, \u5373\u7b2c \\(k\\) \u4e2a\u9875\u7684\u865a\u62df\u5185\u5b58\u8303\u56f4\u4e3a \\([k \\times pageSize, (k+1) \\times pageSize)\\).</p> <p>\u5373\u7528\u4e00\u4e2a\u5730\u5740\u7684\u4f4e\u4f4d\u8868\u793a\u8fd9\u4e2a\u5730\u5740\u5728\u5bf9\u5e94\u9875\u76f8\u5bf9\u9875\u5f00\u5934\u7684\u504f\u79fb\u91cf offset, \u9ad8\u4f4d\u8868\u793a\u9875\u7f16\u53f7, \u6070\u597d\u53ef\u4ee5\u5b8c\u6210\u5730\u5740\u5230\u9875\u548c\u9875\u5185\u5730\u5740\u7684\u6620\u5c04.</p> <p>Pintos \u9875\u5927\u5c0f\u4e3a 4096 \u5b57\u8282, \u4f4e\u4f4d 12 \u4f4d\u7528\u4e8e\u63cf\u8ff0 offset, \u5219\u524d 20 \u4f4d\u53ef\u4ee5\u7528\u4e8e\u9875\u7f16\u53f7.</p> <pre><code>    31               12 11        0\n    +-------------------+-----------+\n    |    Page Number    |   Offset  |\n    +-------------------+-----------+\n            Virtual Address\n</code></pre> <p>\u9875\u7f16\u53f7\u7528\u4e8e\u627e\u5230\u5bf9\u5e94\u7684 page table, page table \u627e frame, frame \u52a0\u4e0a virtual address \u4e2d\u7684 offset \u90e8\u5206\u6620\u5c04\u5230\u7269\u7406\u5185\u5b58.</p> <p>\u4f46\u662f\u5982\u679c\u9700\u8981\u901a\u8fc7\u9875\u7f16\u53f7\u627e\u5230\u5bf9\u5e94\u7684 page table, \u5c31\u9700\u8981\u4fdd\u8bc1\u6240\u6709\u7684 page table \u90fd\u5728\u5185\u5b58\u4e2d, \u4f46\u662f\u5e76\u4e0d\u662f\u6240\u6709\u7684 page \u90fd\u5b58\u5728, \u8fd9\u6837\u4f1a\u5bfc\u81f4 page table \u5360\u7528\u5927\u91cf\u5185\u5b58. \u5f15\u5165 page directory, \u5212\u5206\u5730\u5740\u7684\u9ad8 10 \u4f4d\u4e3a page directory index, \u4f4e 10 \u4f4d\u4e3a page table index, \u672b\u5c3e 12 \u4f4d\u4e3a offset.</p> <pre><code>    31                22 21        12 11          0\n    +-------------------+------------+------------+\n    | Page Directory Idx| Page Table |   Offset   |\n    +-------------------+------------+------------+\n                Virtual Address\n</code></pre> <p>\u9664\u6b64\u4e4b\u5916, \u8fd8\u9700\u8981 swap slot, \u7528\u4e8e\u660e\u786e\u5982\u4f55\u5b58\u50a8\u88ab\u6362\u51fa\u7684 page.</p>"},{"location":"pintos/proj3/#virtual-address-physical-address","title":"virtual address -&gt; physical address","text":"<p>\u56de\u987e\u76ee\u524d\u7684\u7ed3\u6784</p> <ol> <li>\u6bcf\u4e2a process \u6709\u4e00\u4e2a page directory, \u9694\u79bb\u4e86\u4e0d\u540c\u8fdb\u7a0b\u7684\u5185\u5b58</li> <li>page directory \u5305\u542b\u8bb8\u591a page table</li> <li>page table \u5305\u542b\u8bb8\u591a page</li> <li>page \u8868\u793a\u4e00\u6bb5\u865a\u62df\u5185\u5b58</li> <li>page \u7684\u60c5\u51b5<ul> <li>\u6709\u7684 page \u5bf9\u5e94\u4e86 frame</li> <li>\u6709\u7684 page \u5bf9\u5e94\u4e86 swap slot</li> <li>\u6709\u7684 page \u5730\u5740\u5408\u6cd5\u4f46\u662f\u6ca1\u6709\u88ab\u5206\u914d</li> </ul> </li> </ol> <p>\u73b0\u5728, \u6211\u4eec\u6709\u4e00\u4e2a 32-bit \u7684 virtual address, \u9700\u8981\u627e\u5230\u5bf9\u5e94\u7684 physical address.</p> <ol> <li>\u901a\u8fc7 <code>struct thread</code> \u7684 <code>pagedir</code> \u6307\u9488\u627e\u5230 page directory</li> <li>\u901a\u8fc7 virtual address \u7684\u9ad8 10 \u4f4d\u5728 page directory \u4e2d\u627e\u5230\u6307\u5411\u5bf9\u5e94\u7684\u9875\u76ee\u5f55\u9879 (page table \u7684\u7269\u7406\u5730\u5740) \u7684\u6307\u9488  <code>lookup_page() pde = pd + pd_no (vaddr);</code></li> <li>\u901a\u8fc7 kernel pool \u91cc\u9762 virtual address \u548c physical address \u7684\u6620\u5c04\u5173\u7cfb\u627e\u5230\u5bf9\u5e94\u7684 page table \u7684\u865a\u62df\u5730\u5740 <code>lookup_page() pt = pde_get_pt (*pde);</code></li> <li>\u901a\u8fc7 virtual address \u7684\u4e2d\u95f4 10 \u4f4d\u5728 page table \u4e2d\u627e\u5230\u6307\u5411\u5bf9\u5e94\u7684\u9875\u8868\u9879 (page \u7684\u5730\u5740) \u7684\u6307\u9488 <code>lookup_page() return &amp;pt[pt_no (vaddr)];</code></li> </ol>"},{"location":"pintos/proj3/#palloc_get_page-pal_user","title":"<code>palloc_get_page (PAL_USER)</code> \u5728\u5e72\u4ec0\u4e48","text":"<p>\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a <code>palloc_get_page (PAL_USER)</code> \u662f\u5728\u5206\u914d\u4e00\u4e2a frame, \u5728 physical memory \u7684\u6bd4 kernel \u6620\u5c04\u5230\u7684\u66f4\u9ad8\u4f4d\u7684\u5730\u5740\u83b7\u5f97\u4e86\u4e00\u4e2a frame, \u4e0d\u8fc7\u9700\u8981 <code>install_page</code> \u5c06\u8fd9\u4e2a frame \u5199\u5165 page dir &amp; page table \u548c virtual address \u5efa\u7acb\u6620\u5c04\u5173\u7cfb. (\u5982\u679c\u662f <code>palloc_get_page (0)</code>, \u90a3\u4e48\u6620\u5c04\u5173\u7cfb\u5df2\u7ecf\u5728 <code>init_page_dir</code> \u91cc\u9762\u5efa\u7acb\u597d\u4e86, \u76f4\u63a5\u6309\u8fd4\u56de\u7684\u6307\u9488\u4f7f\u7528\u5373\u53ef)</p> <p>\u4e5f\u5c31\u662f\u8bf4, user program \u8ba4\u4e3a\u9ad8\u5730\u5740\u662f\u6808\u533a, \u4f4e\u5730\u5740\u662f\u5168\u5c40\u533a, \u4f46\u662f\u5b9e\u9645\u4e0a\u8fd9\u4e9b\u5730\u5740\u90fd\u662f\u865a\u62df\u5730\u5740, \u4e0d\u4e00\u5b9a\u771f\u7684\u5728\u7269\u7406\u5185\u5b58\u7684\u9ad8/\u4f4e\u5730\u5740.</p>"},{"location":"pintos/proj3/#page-fault","title":"page fault","text":"<p>\u5728\u6709\u865a\u62df\u5185\u5b58\u65f6, page fault \u6709\u66f4\u591a\u79cd\u60c5\u51b5</p> <ul> <li>\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u5408\u6cd5<ul> <li>\u6ca1\u6709\u5bf9\u5e94\u7684\u9875</li> <li>\u5bf9\u5e94\u7684\u9875\u6ca1\u6709\u8f7d\u5165\u5185\u5b58</li> </ul> </li> <li>\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u975e\u6cd5<ul> <li>\u4e2d\u6b62\u8fdb\u7a0b, \u9632\u6b62\u64cd\u4f5c\u7cfb\u7edf\u5d29\u6e83</li> </ul> </li> </ul>"},{"location":"pintos/proj3/#_3","title":"\u603b\u7ed3","text":"<p>Pintos \u7684\u5185\u5b58\u7ed3\u6784\u51b3\u5b9a\u4e86\u6211\u4eec\u9700\u8981\u7ba1\u7406\u7684\u90e8\u5206\u4e3a\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u65f6\u7684\u9759\u6001/\u5168\u5c40\u533a\u5185\u5b58, \u4ee5\u53ca\u6808\u5185\u5b58 (\u5728\u8bbf\u95ee\u5230\u65f6\u5b9e\u73b0 stack growth \u800c\u4e0d\u662f\u7ed3\u675f\u8fdb\u7a0b), \u8fd9\u4e9b\u90e8\u5206\u662f\u4f1a\u88ab swap in/out \u7684, \u5728 <code>PHYS_BASE</code> \u4e4b\u4e0a\u7684\u5185\u6838\u5185\u5b58\u4e0d\u9700\u8981\u8fd9\u65b9\u9762\u8003\u8651.</p> <p>\u7528\u6237\u5185\u5b58\u884c\u4e3a\u5305\u62ec</p> <ol> <li>\u9759\u6001\u533a\u5185\u5b58: \u5728\u4f4e\u5730\u5740, \u5927\u5c0f\u5728\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u65f6\u53ef\u4ee5\u786e\u5b9a.</li> <li>\u6808\u533a: \u5728\u9ad8\u5730\u5740, \u9700\u8981\u786e\u5b9a\u4e00\u4e2a\u589e\u957f\u7b56\u7565.</li> <li>\u975e\u6cd5\u8bbf\u95ee: \u5bfc\u81f4 exit -1</li> </ol> <p>\u9759\u6001\u533a\u9700\u8981\u5b9e\u73b0 lazy loading, \u5373\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6\u65f6\u4e0d\u8f7d\u5165\u5185\u5b58, \u5728\u8bbf\u95ee\u65f6\u51fa\u73b0 page fault \u65f6\u8f7d\u5165.</p> <p>\u6808\u533a\u9700\u8981\u5b9e\u73b0 stack growth, \u5148\u5224\u65ad\u5f53\u524d\u884c\u4e3a\u662f\u53ef\u80fd\u5bfc\u81f4\u5806\u6808\u8fd8\u662f\u975e\u6cd5\u8bbf\u95ee, \u7136\u540e\u6839\u636e\u60c5\u51b5\u5904\u7406\u662f\u5426\u8981\u4e3a\u6808\u533a\u5206\u914d\u65b0\u7684 page.</p> <p>\u9664\u6b64\u4e4b\u5916, \u9700\u8981\u5b9e\u73b0 swap in/out, \u5728\u65e0\u6cd5\u5206\u914d\u65b0\u7684 frame \u65f6, \u5c06\u4e0d\u5e38\u7528\u7684 page \u6362\u51fa\u5230 disk \u4e0a. \u6709\u88ab\u4fee\u6539\u7684 page \u9700\u8981\u5199\u56de disk (\u6709 dirty bit \u7684\u60c5\u51b5), \u800c\u6ca1\u6709\u88ab\u4fee\u6539\u7684 page \u53ef\u4ee5\u76f4\u63a5\u4e22\u5f03, \u5728\u9700\u8981\u65f6\u53ef\u4ee5\u4ece\u539f\u6765\u7684\u6587\u4ef6\u8f7d\u5165.</p>"},{"location":"pintos/proj3/#task-1-paging","title":"Task 1: Paging","text":""},{"location":"pintos/proj3/#_4","title":"\u7ed3\u6784","text":"<p>\u9996\u5148\u9700\u8981\u5efa\u7acb page table \u7ed3\u6784, \u628a\u6bcf\u4e2a frame \u9700\u8981\u4ece user pool \u53d6\u5f97 (<code>palloc_get_page (PAL_USER)</code>, \u9700\u8981\u6e05\u7a7a\u5219\u6539\u4e3a <code>palloc_get_page (PAL_USER | PAL_ZERO)</code> ) \u7684\u8fc7\u7a0b\u5957\u58f3, \u65b9\u4fbf\u8bb0\u5f55\u4fe1\u606f. \u5728\u5206\u914d\u4e00\u4e2a page \u4e4b\u540e, \u9700\u8981\u8c03\u7528 <code>install_page</code> \u5c06 page \u6dfb\u52a0\u5230\u5f53\u524d\u8fdb\u7a0b\u7684 page directory \u4e2d.</p> <pre><code>struct frame_or_whatever {\n    void *kaddr;\n};\n</code></pre> <p>\u6587\u6863\u63d0\u5230:</p> <p>To simplify your design, you may store these data structures in non-pageable memory. That means that you can be sure that pointers among them will remain valid.</p> <p>\u8fd9\u91cc\u7684 non-pageable memory \u6307\u7684\u662f kernel pool, \u4e5f\u5c31\u662f\u8bf4\u6700\u597d\u5728 kernel pool \u91cc\u9762\u5206\u914d frame.</p> <p>\u5982\u679c\u6539\u6210\u52a0\u4e0a ref count, \u53ef\u4ee5\u5b9e\u73b0\u5171\u4eab frame (\u60f3\u4e86\u4e00\u4e0b, \u597d\u96be).</p> <pre><code>struct frame_table_entry{\n    void *kaddr;                        // Kernel address\n    struct sup_page_table_entry *spte;  // Supplementary page table entry\n    struct thread* owner;               // Owner of the frame\n    struct list_elem elem;              // List element for list of all frames\n    bool pinned;                        // Is frame pinned\n};\n</code></pre> <p>\u7136\u540e\u9700\u8981\u5b9e\u73b0 supplmentary page table, \u7528\u4e8e\u8bb0\u5f55 page \u7684\u4fe1\u606f, \u72b6\u6001, \u5728 page fault \u65f6\u4f1a\u4ee5\u8fd9\u4e9b\u4e1c\u897f\u51b3\u5b9a\u52a0\u8f7d page \u65b9\u5f0f.</p> <pre><code>enum sup_page_type{\n    PAGE_ZERO,    // All zero page\n    PAGE_FILE,    // Page from file\n    PAGE_STACK,   // Page on frame\n    PAGE_MMAP     // Memory mapped file\n};\n\nstruct sup_page_table_entry {\n    void *uaddr;              // User virtual address\n    void *kaddr;              // Kernel virtual address\n\n    bool writable;            // Is page writable\n    enum sup_page_type type;  // Type of page\n\n    struct lock spte_lock;    // Lock for page (wait for swapping to be done)\n\n    struct file *file;        // File to load page from\n    off_t offset;             // Offset in file\n    uint32_t read_bytes;      // Number of bytes to read\n    uint32_t zero_bytes;      // Number of bytes to zero\n\n    struct hash_elem elem;    // Hash element for supplementary page table\n\n    size_t swap_index;        // Swap index\n};\n</code></pre> <p>\u8fd8\u9700\u8981\u5b9e\u73b0 swap, \u4f7f\u7528 device/block.h \u91cc\u9762\u7684 block device, \u7528\u4e8e\u8bfb\u5199 swap slot.</p> <p>\u5728 <code>swap_init</code> \u91cc\u9762\u521d\u59cb\u5316 swap slot, <code>block_get_role (BLOCK_SWAP);</code> \u53ef\u4ee5\u83b7\u53d6 swap slot \u7684 block device.</p> <p>\u6309\u7167 page \u5927\u5c0f\u51b3\u5b9a\u6bcf\u4e2a page \u9700\u8981\u591a\u5c11 sector, \u5efa\u7acb\u4e00\u4e2a\u603b sector \u6570\u9664\u4ee5\u6bcf\u4e2a page \u9700\u8981\u7684 sector \u6570\u7684 bitmap, \u6bcf\u4e2a bit \u4ee3\u8868\u8fd9\u4e2a swap slot \u662f\u5426\u88ab\u5360\u7528.</p>"},{"location":"pintos/proj3/#_5","title":"\u540c\u6b65\u95ee\u9898","text":"<ol> <li>\u5f53\u591a\u4e2a\u8fdb\u7a0b\u7533\u8bf7 frame \u65f6\u7684 race condition<ul> <li><code>palloc_get_page</code> \u5185\u7f6e\u4e86\u9501, \u4fdd\u8bc1\u5206\u914d\u662f\u539f\u5b50\u7684</li> <li>\u4e00\u4e2a frame \u4ece <code>palloc_get_page</code> \u83b7\u53d6\u5230, \u53e6\u4e00\u4e2a\u9700\u8981 evict frame, \u4e24\u4e2a\u8fdb\u7a0b\u7684 critical section \u662f\u4fee\u6539 frame table \u90e8\u5206, \u9700\u8981\u52a0\u9501</li> <li>\u4e24\u4e2a\u8fdb\u7a0b\u540c\u65f6 evict frame, \u9700\u8981\u4fdd\u8bc1\u4e0d evict \u540c\u4e00\u4e2a frame</li> </ul> </li> <li>\u6b63\u5728\u88ab evict \u7684 frame \u88ab\u539f\u6765\u7684 frame \u6301\u6709\u8005\u8bbf\u95ee<ul> <li>\u4fdd\u8bc1\u5728\u6362\u51fa\u7b49\u7b49\u64cd\u4f5c\u4e4b\u524d\u8fdb\u5165\u5982\u4e0b\u72b6\u6001: \u539f\u6765\u6301\u6709\u8005\u901a\u8fc7 page table \u8bbf\u95ee\u6b64 frame \u65f6\u5f15\u8d77 page fault</li> <li>\u9700\u8981\u4f7f\u7528 <code>pagedir_clear_page</code> \u6e05\u9664 page table \u4e2d\u7684\u6620\u5c04\u5173\u7cfb</li> </ul> </li> <li>\u4e00\u4e2a\u8fdb\u7a0b page fault \u5e76\u4e14\u83b7\u53d6\u5230\u4e86 frame, \u53e6\u4e00\u4e2a\u8fdb\u7a0b\u5c1d\u8bd5 evict \u8fd9\u4e2a frame.</li> <li>\u6b63\u5728\u4ece disk \u8bfb\u53d6 page \u65f6, \u6b64 page \u7684 frame \u4e0d\u5e94\u8be5\u88ab\u5176\u4ed6\u8fdb\u7a0b evict<ul> <li>evict \u65f6\u4ece frame table \u79fb\u9664.</li> <li>\u8bfb\u53d6\u5b8c\u6210\u4e4b\u524d\u4e0d\u52a0\u5165 frame table.</li> </ul> </li> <li>\u5728 syscall \u65f6\u53d1\u751f\u7684 page fault<ul> <li>\u53c2\u89c1 Task 4</li> </ul> </li> <li>\u591a\u4e2a page fault \u7684\u5904\u7406\u53ef\u4ee5\u5e76\u53d1\u8fdb\u884c<ul> <li>\u4fdd\u8bc1\u5bf9\u540c\u4e00\u4e2a frame \u7684\u64cd\u4f5c\u662f\u4e32\u884c\u7684</li> <li>\u9700\u8981 I/O \u7684\u9760 I/O \u7684\u9501\u4e92\u65a5</li> <li>\u9700\u8981 swap \u7684\u9760 swap block \u7684\u9501\u4e92\u65a5</li> </ul> </li> <li>\u5728\u4e00\u6b21 load \u5b8c\u6210\u4e4b\u524d, \u83b7\u53d6\u5230\u7684 frame \u4e0d\u5e94\u8be5\u88ab evict.<ul> <li>\u5148 pin \u4f4f, \u6309\u9700\u8981 unpin</li> </ul> </li> <li>\u5728\u4e00\u4e2a page \u7684 frame \u5b8c\u6210 evict \u4e4b\u524d, \u90a3\u4e2a page \u7684 fault \u4e0d\u80fd\u88ab\u540c\u65f6\u5904\u7406<ul> <li><code>spte_lock</code> \u4fdd\u8bc1 fault \u5904\u7406\u65f6, \u88ab evict \u7684 frame \u5df2\u7ecf\u5b8c\u6574\u4fdd\u5b58\u5230 swap disk.</li> </ul> </li> </ol>"},{"location":"pintos/proj3/#page-fault_1","title":"page fault \u60c5\u51b5\u4e0e\u5bf9\u7b56","text":"\u60c5\u51b5\u7f16\u53f7 <code>not_present</code> <code>write</code> <code>user</code> \u60c5\u51b5 \u5bf9\u7b56 (1) <code>false</code> <code>false</code> <code>false</code> \u5185\u6838\u975e\u6cd5\u8bbf\u95ee <code>exit(-1)</code> (2) <code>false</code> <code>false</code> <code>true</code> \u7528\u6237\u975e\u6cd5\u8bbf\u95ee <code>exit(-1)</code> (3) <code>false</code> <code>true</code> <code>false</code> \u540c\u7406 1 \u540c (4) <code>false</code> <code>true</code> <code>true</code> \u540c\u7406 2 \u540c (5) <code>true</code> <code>false</code> <code>false</code> \u5728 syscall \u4e2d\u9047\u5230 page fault \u5c1d\u8bd5\u8f7d\u5165 &amp; pin, \u5728 syscall \u7ed3\u675f\u4e4b\u524d unpin (6) <code>true</code> <code>false</code> <code>true</code> \u88ab\u6362\u51fa/\u6ca1\u6709\u52a0\u8f7d/\u6808\u589e\u957f \u5c1d\u8bd5\u8f7d\u5165/\u6808\u589e\u957f (7) <code>true</code> <code>true</code> <code>false</code> \u540c 5 \u540c (8) <code>true</code> <code>true</code> <code>true</code> \u540c 6 \u540c"},{"location":"pintos/proj3/#task-2-stack-growth","title":"Task 2: Stack growth","text":"<p>\u5728\u6700\u5f00\u59cb\u5206\u914d\u4e00\u4e2a page \u4f5c\u4e3a\u6808, \u540e\u7eed\u8003\u8651\u6808\u589e\u957f\u7684\u60c5\u51b5. \u6309\u7167 80x86 <code>PUSHA</code> \u6700\u591a\u5728 <code>esp</code> \u4f4e 32 \u5b57\u8282\u7684\u4f4d\u7f6e\u5f15\u53d1 page fault, \u8003\u8651\u5c06 32 \u5b57\u8282\u4f5c\u4e3a\u5206\u754c, \u4f4e\u4e8e 32 \u5b57\u8282\u65f6\u5206\u914d\u65b0\u7684 page, \u5426\u5219\u89c6\u4e3a\u975e\u6cd5\u8bbf\u95ee.</p> <p>\u6808\u589e\u957f\u9501\u5206\u914d\u7684 frame \u4e5f\u53ef\u80fd\u88ab swap out, \u6b64\u65f6\u603b\u662f\u9700\u8981\u4fdd\u5b58 frame \u7684\u5185\u5bb9, \u4ee5\u4fbf\u5728\u9700\u8981\u65f6\u8f7d\u5165.</p> <p>\u53ef\u4ee5\u9650\u5236\u4e00\u4e2a\u8fdb\u7a0b\u6700\u5927\u6808\u533a\u5927\u5c0f, \u4ee5\u9632\u6b62\u65e0\u9650\u589e\u957f.</p>"},{"location":"pintos/proj3/#task-3-memory-mapping-files","title":"Task 3: Memory mapping files","text":"<p>mmap \u4f1a\u5c06\u6587\u4ef6\u6620\u5c04\u5230\u8fde\u7eed\u7684\u9875, \u6620\u5c04\u4e4b\u524d\u68c0\u67e5\u8fd9\u4e9b\u9875\u6ca1\u6709\u88ab\u6620\u5c04.</p> <p>\u6620\u5c04\u65f6\u4f9d\u7136\u9700\u8981 lazy loading, \u53ea\u8bbe\u7f6e supplmentary page table \u4fe1\u606f, \u5728\u8bbf\u95ee\u65f6\u8f7d\u5165.</p> <p>\u5728\u88ab evict \u65f6, \u5c06\u4fee\u6539\u5199\u56de\u6587\u4ef6.</p> <p>mummap \u4f1a\u5c06\u6587\u4ef6\u4ece\u5185\u5b58\u4e2d\u79fb\u9664, \u5c06 dirty \u7684 page \u5199\u56de\u6587\u4ef6.</p> <p>\u4e3a\u4e86\u907f\u514d\u5199\u7684\u65f6\u5019 (\u6b64\u65f6\u83b7\u53d6\u5230\u4e86 <code>filesys_lock</code>) \u53d1\u751f page fault, \u5728\u5199\u4e4b\u524d\u52a0\u8f7d page \u5e76\u4e14 pin \u4f4f, \u5199\u5b8c\u4e4b\u540e\u91ca\u653e spte \u548c\u5bf9\u5e94\u7684 frame.</p>"},{"location":"pintos/proj3/#task-4-accessing-user-memory","title":"Task 4: Accessing user memory","text":"<p>\u9700\u8981\u4fdd\u8bc1\u5728\u8fdb\u5165\u5185\u6838\u65f6, \u7528\u6237\u5185\u5b58\u662f\u5408\u6cd5\u7684, \u4e14\u9700\u8981\u907f\u514d\u4e00\u4e9b\u6301\u6709\u8d44\u6e90\u60c5\u51b5\u4e0b\u9047\u5230 page fault \u7684\u60c5\u51b5.</p> <p>\u60c5\u666f: \u8fdb\u7a0b A syscall read, \u4f46\u662f read \u7684 buffer \u4e0d\u5728\u5185\u5b58\u4e2d, \u9700\u8981\u4e3a buffer \u5206\u914d frame, \u6b64\u65f6 A \u6301\u6709 <code>filesys_lock</code>. \u8fdb\u7a0b B \u5f15\u53d1 page fault, \u83b7\u53d6\u4e86 <code>frame_table_lock</code>, \u4f46\u662f\u4e3a\u4e86 evict frame \u9700\u8981\u83b7\u53d6 <code>filesys_lock</code> (\u4f8b\u5982\u4ece B \u7684\u53ef\u6267\u884c\u6587\u4ef6\u8bfb bss \u4fe1\u606f, \u628a evict \u7684\u90e8\u5206\u5199\u56de\u6587\u4ef6\u7cfb\u7edf), \u6b64\u65f6 A \u548c B \u4e92\u76f8\u7b49\u5f85\u5bf9\u65b9\u91ca\u653e\u9501, \u9020\u6210\u6b7b\u9501.</p> <p>\u5728\u5185\u6838\u53d1\u751f page fault (\u4fdd\u8bc1\u5176\u4ed6\u90e8\u5206\u6ca1\u6709\u9519\u8bef, \u5219\u6b64\u65f6\u5fc5\u7136\u662f syscall \u4e2d\u7684 page fault) \u65f6, \u52a0\u8f7d\u540c\u65f6 pin \u4f4f frame, \u5728 syscall \u7ed3\u675f\u4e4b\u524d unpin.</p>"},{"location":"pintos/proj3/#_6","title":"\u5b9e\u73b0","text":""},{"location":"pintos/proj3/#swap","title":"swap","text":"<p>\u5b9a\u4e49\u4e8e <code>vm/swap.h</code>, <code>vm/swap.c</code>, \u7528\u4e8e\u7ba1\u7406 swap slot.</p> <p>\u5728 <code>thread/vaddr.h</code> \u91cc\u9762\u5b9a\u4e49\u4e86 <code>PGSIZE</code> (4096), \u8868\u793a page \u7684\u5927\u5c0f. \u5728 <code>devices/block.h</code> \u91cc\u9762\u5b9a\u4e49\u4e86 <code>BLOCK_SECTOR_SIZE</code>, \u8868\u793a block \u7684\u5927\u5c0f (512), \u4e8e\u662f\u6bcf\u4e2a\u6362\u51fa\u7684 page  \u5360\u7528\u7684 sector \u6570\u5373\u4e3a <code>PGSIZE / BLOCK_SECTOR_SIZE</code>.</p> <p>\u5305\u542b\u4e00\u4e2a bitmap \u7528\u4e8e\u8bb0\u5f55 swap slot \u7684\u4f7f\u7528\u60c5\u51b5. \u5728\u521d\u59cb\u5316\u65f6, \u901a\u8fc7 <code>block_get_role (BLOCK_SWAP)</code> \u83b7\u53d6 swap block, \u7136\u540e\u8ba1\u7b97\u51fa swap slot \u7684\u6570\u91cf, \u521d\u59cb\u5316 bitmap.</p> <p>\u7531\u4e8e\u4e0d\u786e\u5b9a block \u662f\u5426\u652f\u6301\u5e76\u53d1\u8bfb\u5199, \u6240\u4ee5\u9700\u8981\u52a0\u5168\u5c40\u9501 <code>swap_lock</code>, \u5982\u679c\u53ef\u4ee5\u5e76\u53d1\u8bfb\u5199, \u90a3\u4e48\u53ea\u9700\u8981\u9501 <code>swap_bitmap</code> \u5373\u53ef.</p> <p>\u5728 <code>swap_out</code> \u65f6, \u627e\u5230\u4e00\u4e2a\u7a7a\u95f2\u7684 swap slot, \u8bbe\u7f6e\u4e3a\u5360\u7528, \u7136\u540e\u5c06 frame \u5199\u5165 swap slot, \u8fd4\u56de swap slot \u7684\u7f16\u53f7.</p> <p>\u5728 <code>swap_in</code> \u65f6, \u8bfb\u53d6 swap slot \u7684\u5185\u5bb9, \u5c06\u5176\u5199\u5165 frame, \u7136\u540e\u91ca\u653e swap slot.</p>"},{"location":"pintos/proj3/#frame","title":"frame","text":"<p>\u5b9a\u4e49\u4e8e <code>vm/frame.h</code> ,<code>vm/frame.c</code>, \u7528\u4e8e\u7ba1\u7406 frame.</p> <pre><code>struct frame_table_entry {\n    void *kaddr;                        // Kernel address\n    struct sup_page_table_entry *spte;  // Supplementary page table entry\n    struct thread* owner;               // Owner of the frame\n    struct list_elem elem;              // List element for list of all frames\n    bool pinned;                        // Is frame pinned\n};\n</code></pre> <p>frame \u9700\u8981\u5b9e\u73b0\u5305\u542b\u4e86 eviction \u7684\u4e0e <code>palloc_get_page (PAL_USER)</code>, <code>palloc_free_page</code> \u540c\u529f\u80fd\u7684\u51fd\u6570.</p> <p>\u7531\u4e8e\u4f7f\u7528 <code>list</code> \u6765\u7ba1\u7406 frame, \u6240\u4ee5\u9700\u8981\u52a0\u9501 <code>frame_lock</code>.</p>"},{"location":"pintos/proj3/#page","title":"page","text":"<pre><code>enum sup_page_type\n  {\n    PAGE_ZERO,    // All zero page\n    PAGE_FILE,    // Page from file\n    PAGE_STACK,   // Page on frame\n    PAGE_MMAP     // Memory mapped file\n  };\n\nstruct sup_page_table_entry\n  {\n    void *uaddr;              // User virtual address\n    void *kaddr;              // Kernel virtual address\n\n    bool writable;            // Is page writable\n    enum sup_page_type type;  // Type of page\n\n    struct lock spte_lock;    // Lock for page (wait for swapping to be done)\n\n    struct file *file;        // File to load page from\n    off_t offset;             // Offset in file\n    uint32_t read_bytes;      // Number of bytes to read\n    uint32_t zero_bytes;      // Number of bytes to zero\n\n    struct hash_elem elem;    // Hash element for supplementary page table\n\n    size_t swap_index;        // Swap index\n  };\n</code></pre> <p>\u5728 <code>struct thread</code> \u5185\u52a0\u4e0a <code>struct hash sup_page_table</code>, \u6ce8\u610f <code>hash</code> \u521d\u59cb\u5316\u65f6\u9700\u8981\u5206\u914d\u5185\u5b58\u7528\u4e8e\u521b\u5efa\u6876, \u9700\u8981\u5728\u7cfb\u7edf\u521d\u59cb\u5316\u5b8c\u6210\u540e\u624d\u80fd\u8c03\u7528, \u4e0d\u5728\u521b\u5efa <code>main</code> \u7b49\u5185\u6838\u7ebf\u7a0b\u7684\u65f6\u5019\u8c03\u7528\u5373\u53ef.</p>"},{"location":"pintos/proj3/#supplementary-page","title":"\u521b\u5efa supplementary page","text":"<p>\u5728 <code>mmap</code>, <code>load</code> \u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6, page fault \u4e2d\u89e6\u53d1\u6808\u589e\u957f\u65f6\u521b\u5efa.</p>"},{"location":"pintos/proj3/#supplementary-page-table","title":"\u4f7f\u7528 supplementary page table","text":"<p>spt \u7684\u7528\u5904\u5373\u5728\u53d1\u751f page fault \u65f6, \u63d0\u4f9b\u5173\u4e8e\u8be5 page \u7684\u989d\u5916\u4fe1\u606f.</p> <p>\u901a\u8fc7 hash table, \u4ee5\u5730\u5740\u5feb\u901f\u67e5\u627e\u5bf9\u5e94\u7684 spte.</p>"},{"location":"pintos/proj3/#_7","title":"\u52a0\u8f7d\u53ef\u6267\u884c\u6587\u4ef6","text":"<p>\u5b9e\u73b0 lazy loading</p> <p>\u4e00\u4e2a page \u6709\u4ee5\u4e0b\u51e0\u79cd\u60c5\u51b5:</p> <ul> <li>\u6765\u81ea\u53ef\u6267\u884c\u6587\u4ef6 (\u7a0b\u5e8f\u9759\u6001\u533a\u5185\u5b58)<ul> <li>\u6ca1\u6709\u52a0\u8f7d</li> <li>\u52a0\u8f7d\u5230\u4e86\u5185\u5b58\u91cc\u9762, dirty / \u4e0d dirty<ul> <li>\u7531\u662f\u5426 dirty \u51b3\u5b9a\u662f\u5426\u9700\u8981\u6362\u51fa.</li> <li>\u4e00\u65e6 dirty \u5c31\u6c38\u8fdc\u88ab\u6807\u8bb0\u4e3a dirty</li> </ul> </li> <li>\u88ab\u6362\u51fa, \u5728 swap slot \u91cc\u9762</li> </ul> </li> <li>\u6765\u81ea\u6587\u4ef6\u7cfb\u7edf (mmap) <code>PAGE_MMAP</code><ul> <li>\u52a0\u8f7d\u5230\u4e86\u5185\u5b58\u91cc\u9762, dirty / \u4e0d dirty</li> <li>\u88ab\u6362\u51fa, \u5373\u88ab\u5b58\u56de\u6587\u4ef6\u91cc\u9762</li> </ul> </li> <li>\u6808<ul> <li>\u6808\u589e\u957f\u65b0\u589e\u7684</li> <li>\u88ab\u6362\u51fa</li> </ul> </li> </ul>"},{"location":"pintos/proj3/#page-fault_2","title":"\u5904\u7406 page fault","text":""},{"location":"pintos/proj3/#_8","title":"\u6808\u589e\u957f","text":"<p>32 \u4f4d\u673a\u5668, <code>PUSHA</code> \u6307\u4ee4\u4f1a\u5c06 32 \u5b57\u8282\u7684\u6570\u636e\u538b\u5165\u6808, \u6240\u4ee5\u53ef\u4ee5\u8ba4\u4e3a\u6700\u5927\u7684\u6808\u589e\u957f\u662f\u4e00\u6b21 32 \u5b57\u8282\u7684\u64cd\u4f5c, \u8d85\u8fc7 32 \u5b57\u8282\u7684\u64cd\u4f5c\u89c6\u4e3a\u975e\u6cd5\u8bbf\u95ee.</p> <p>\u540c\u65f6\u68c0\u67e5\u5f53\u524d\u603b\u8ba1\u7684\u6808\u533a\u5927\u5c0f, \u5982\u679c\u8d85\u8fc7\u4e86\u9650\u5236, \u4e5f\u89c6\u4e3a\u975e\u6cd5\u8bbf\u95ee.</p> <p>\u4f46\u662f\u5b58\u5728\u4e00\u4e2a\u95ee\u9898, \u5982\u679c\u5728 kernel mode \u89e6\u53d1 page fault, \u6b64\u65f6\u6ca1\u6709\u6808\u6307\u9488\u7684\u4fe1\u606f, \u9700\u8981\u5728 syscall \u65f6\u8bb0\u5f55\u4ee5\u5b9e\u73b0 syscall \u4e2d\u6808\u589e\u957f.</p>"},{"location":"pintos/proj3/#_9","title":"\u52a0\u8f7d","text":"<p>\u5728 kernel \u60c5\u51b5\u4e0b\u53d1\u751f\u7684 page fault, \u9700\u8981\u5224\u65ad\u662f\u5426\u662f\u5408\u6cd5\u8bbf\u95ee, \u5982\u679c\u662f\u5408\u6cd5\u8bbf\u95ee, \u9700\u8981\u5c06 page \u52a0\u5165\u5230 frame table \u4e2d, \u5e76 pin \u4f4f, \u5728 syscall \u7ed3\u675f\u4e4b\u524d unpin, \u9632\u6b62\u6b7b\u9501</p> <p>\u5728 user \u60c5\u51b5\u4e0b\u53d1\u751f\u7684 page fault \u4e0d\u8003\u8651 pin \u7684\u95ee\u9898.</p>"},{"location":"pintos/proj3/#mmapmunmap","title":"mmap/munmap","text":"<p>\u5728 <code>struct thread</code> \u5185\u52a0\u4e0a <code>struct list mmap_list</code></p> <pre><code>struct mmap_file\n  {\n    mapid_t mapid;\n    struct file *file;\n    struct list_elem elem;\n    void *base;\n  };\n</code></pre> <p><code>mmap</code> \u65f6\u9700\u8981 <code>file_reopen</code> \u4ee5\u4fdd\u8bc1\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0d\u4f1a\u88ab\u5173\u95ed, \u8bb0\u5f55 <code>base</code> \u4ee5\u5728 <code>munmap</code> \u65f6\u67e5\u627e\u7136\u540e\u91ca\u653e\u5bf9\u5e94\u7684 spte.</p>"},{"location":"pintos/proj4/","title":"Project 4: File System","text":"<p>No plagiarism</p> <p>If you are enrolled in CS130, you may not copy code from this repository.</p> <p>\u6025\u4e86\u6025\u4e86\u6025\u4e86</p> <p>Project 4 \u57fa\u4e8e Project 2 \u6216 3, \u5e0c\u671b\u4f60\u7684 Project \u8db3\u591f robust.</p> <p>Overview</p> <ul> <li>Task 1 : indexed and extensible files</li> <li>Task 2 : subdirectories</li> <li>Task 3 : buffer cache</li> <li>Task 4 : synchronization</li> </ul>"},{"location":"pintos/proj4/#_1","title":"\u6587\u4ef6\u7cfb\u7edf\u9650\u5236\u9700\u8981\u88ab\u4f60\u89e3\u9664","text":"<ul> <li>\u53ef\u80fd\u5e76\u53d1\u8bbf\u95ee\u6587\u4ef6, \u5373 Task 4 \u8981\u63d0\u4f9b\u7684\u540c\u6b65</li> <li>\u6587\u4ef6\u5927\u5c0f\u4e0d\u518d\u56fa\u5b9a</li> </ul>"},{"location":"pintos/proj4/#_2","title":"\u5206\u6790","text":"<p>\u8fd9\u91cc\u7a7a\u7a7a\u7684, \u4ec0\u4e48\u4e5f\u6ca1\u6709.</p>"}]}